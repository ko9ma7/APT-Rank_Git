<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-KNL2VQN');</script>
  <!-- End Google Tag Manager -->

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-TEV7JMPP7S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-TEV7JMPP7S');

  if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('serviceWorker.js')
    .then((reg) => {
      //console.log('Service Worker Registered!', reg);
    });
  }
  </script>

  <title>아파트랭크 - 데이터로 분석된 아파트 입지 순위</title>
  <meta property="og:type" content="website">
  <meta property="og:title" content="아파트랭크">
  <meta property="og:description" content="데이터로 분석된 대한민국 아파트 입지">
  <meta property="og:image" content="https://www.aptrank.kr/thumbnail_2.jpg">
  <meta property="og:url" content="https://www.aptrank.kr/">
  <meta name="keyword" content="아파트랭크, 아파트순위, 부동산, 아파트, 입지, 순위, 아파트입지, 우리동네, 호가, 대장아파트, 최고가, 신고가, 호재, AI, 등수, 아파트 실거래가, 아파트 시세, 재건축, 재개발, 실거래가, 시세, 호가, 매매, 전세, 월세">
  <meta name="description" content="데이터로 분석된 대한민국 아파트 입지 | 숫자로 보는 아파트 입지 분석, 아파트랭크">
  <meta name="author" content="아파트랭크">
  <meta name="robots" content="index,follow">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <meta charset="utf-8">

  <!-- 주소창 등의 웹 브라우저 UI를 표시하지 않기 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- 상태 바의 스타일을 지정 -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- 홈 화면에서 표시되는 앱 이름을 지정 -->
  <meta name="apple-mobile-web-app-title" content="아파트랭크">
  <!-- 홈 화면에서 표시되는 앱 아이콘을 지정 -->
  <link rel="apple-touch-icon" href="https://www.aptrank.kr/apt-rank-152x152.png">
  <!-- 웹 앱 매니페스트를 읽어 들이기 -->
  <link rel="manifest" href="manifest.json">  

  <link rel="canonical" href="https://www.aptrank.kr/">
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <link rel="shortcut icon" href="https://www.aptrank.kr/apr-rank.png"/>


  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.5.0-beta4/html2canvas.min.js"  crossorigin="anonymous"></script>
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>

  <script src="./js/menu_select_box.js" type="text/javascript"></script>
  <script src="./js/draw_chart.js" type="text/javascript"></script>
  <script src="./js/sort.js" type="text/javascript"></script>
  <script src="./js/search.js" type="text/javascript"></script>
  <script src="./js/rearrange.js" type="text/javascript"></script>
  <script src="./js/share.js" type="text/javascript"></script>
  <script src="./js/weight_cal.js" type="text/javascript"></script>
  <script src="./js/weight_array.js" type="text/javascript"></script>
  <script src="./js/simulation.js" type="text/javascript"></script>
  <script src="./js/top300.js" type="text/javascript"></script>
  <script src="./js/kakao_sendtome.js" type="text/javascript"></script>
  <script src="./js/notice_aptrank.js" type="text/javascript"></script>

  <link href="./css/style.css" rel="stylesheet"/>
  <link href="./css/slider.css" rel="stylesheet"/>

  <script src="./js/doubleSlider.js" type="text/javascript"></script>
</head>
<style>
</style>

<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KNL2VQN"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->

  <div id="container">
    <div id="centerBox">
      <div id="titleBar">
        <!--검색 버튼 표시-->
        <div id='search' onClick='showSearchBar(this)'><i class="fas fa-search"></i></div>
        <!--재정렬 버튼 표시-->
        <div id="rearrange" class="position-relative" onClick='showRearrangeBar(this)'><i class="fa-solid fa-arrow-down-wide-short"></i></div>
        <!--타이틀 표시-->
        <div id="title" onClick='scrollUp()'>아파트랭크</div>
        <!-- <div id="title" onClick='sendTo()'>아파트랭크</div> -->
        <!--공유 버튼-->
        <!-- <div id="search" onClick='share(shareTitle, shareText, shareURL)'><i class='fa-solid fa-arrow-up-right-from-square'></i></div> -->
        <!--단지 가중치 설정 버튼 표시-->
        <div id='sort' class="position-relative" data-bs-toggle='modal' data-bs-target='#exampleModal' id='myModal' onClick='showSorting()'><i class="fa-solid fa-sliders"></i></div>
        <div id='help' data-bs-toggle='modal' data-bs-target='#exampleModal' id='myModal' onClick='showNotice()'><i class="fa-solid fa-circle-question"></i></div>

      </div>

      <div id="selections">
        <div id="sido_selection"><select id="sido" onChange="sidoChange()"></select></div>
        <div id="gungu_selection"><select id="gungu" onChange="updateRegion()"></select></div>    
        <div id="month_selection">
          <select id="month" onChange="updateMonth()">
            <option value="202211" selected>2022년 11월</option>
            <option value="202210">2022년 10월</option>
            <option value="202209">2022년 09월</option>
            <option value="202208">2022년 08월</option>
            <option value="202207">2022년 07월</option>
            <option value="202206">2022년 06월</option>
            <option value="202205">2022년 05월</option>
            <option value="202204">2022년 04월</option>
            <option value="202203">2022년 03월</option>
            <option value="202202">2022년 02월</option>
            <option value="202201">2022년 01월</option>
          </select>
        </div>
      </div>

      <!--단지 가중치 표시창-->
      <!-- <div id="weight" data-bs-toggle='modal' data-bs-target='#exampleModal' onClick='showSorting()'></div> -->
      <div id="weight"></div>

      <!--단지 검색창-->
      <div id="searchCard">
        <div id="iconSearch"><i class="fas fa-search"></i></div>
        <div id="searchGuide">
          <div id="searchNotice"></div>
          <div id="inputBox"><input id="inputSearch" type="text" placeholder="어느 단지를 찾아볼까요?" onkeyup="aptSearch()"></div>
          <div id="searchExample">예) 서초동, 래미안, 힐스테이트, 주공</div>

        </div>
        <div id="closeSearch" onClick='closeSearch()' ><i class="fas fa-times"></i></div>
      </div>

      <!--시군구 검색창-->
      <div id="regionSearchCard">
        <div id="iconSearch"><i class="fas fa-search"></i></div>
        <div id="regionSearchGuide">
          <div id="regionSearchNotice">전국 시군구 이름으로 검색합니다.</div>
          <div id="regionInputBox"><input id="regionInputSearch" type="text" placeholder="어느 시군구를 찾아볼까요?" onkeyup="regionSearch()"></div>
          <div id="regionSearchExample">예) 서울, 창원, 강남, 서구</div>

        </div>
        <div id="closeRegionSearch" onClick='closeRegionSearch()' ><i class="fas fa-times"></i></div>
      </div>

      <!--단지 정렬창-->
      <div id="rearrangeCard">
        <div id="iconRearrange"><i class="fa-solid fa-arrow-down-wide-short"></i></div>
        <div id="rearrangeContatiner">
            <div id="rearrangeNotice"></div>
            <div class='rearrangeArea'>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangeScore' onClick='rearrangeAPTList(this)'><label class='btn btn-outline-danger' for='rearrangeScore'>총점순</label></div>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangeRank' onClick='rearrangeAPTList(this)'><label class='btn btn-outline-danger' for='rearrangeRank'>순위변동순</label></div>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangePrice' onClick='rearrangeAPTList(this)'><label class='btn btn-outline-danger' for='rearrangePrice'>실거래가순</label></div>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangeNew' onClick='rearrangeAPTList(this)'><label class='btn btn-outline-danger' for='rearrangeNew'>신축순</label></div>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangeHouse' onClick='rearrangeAPTList(this)'><label class='btn btn-outline-danger' for='rearrangeHouse'>세대수순</label></div>
            </div>
        </div>
        <div id="closeRearrange" onClick='closeRearrange()' ><i class="fas fa-times"></i></div>
      </div>

      <!--시군구 정렬창-->
      <div id="rearrangeRegionCard">
        <div id="iconRearrange"><i class="fa-solid fa-arrow-down-wide-short"></i></div>
        <div id="rearrangeContatiner">
            <div id="rearrangeRegionNotice"></div>
            <div class='rearrangeArea'>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangeRegionScore' onClick='rearrangeRegionList(this)'><label class='btn btn-outline-danger' for='rearrangeRegionScore'>총점순</label></div>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangeRegionRank' onClick='rearrangeRegionList(this)'><label class='btn btn-outline-danger' for='rearrangeRegionRank'>순위변동순</label></div>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangeRegionPop' onClick='rearrangeRegionList(this)'><label class='btn btn-outline-danger' for='rearrangeRegionPop'>인구순</label></div>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangeRegionPopUpDown' onClick='rearrangeRegionList(this)'><label class='btn btn-outline-danger' for='rearrangeRegionPopUpDown'>인구증감순</label></div>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangeRegionJob' onClick='rearrangeRegionList(this)'><label class='btn btn-outline-danger' for='rearrangeRegionJob'>일자리순</label></div>
              <div><input type='radio' class='btn-check' name='btnRearrange' autocomplete='off' id='rearrangeRegionIncome' onClick='rearrangeRegionList(this)'><label class='btn btn-outline-danger' for='rearrangeRegionIncome'>소득순</label></div>
            </div>
        </div>
        <div id="closeRegionRearrange" onClick='closeRegionRearrange()' ><i class="fas fa-times"></i></div>
      </div>

      <!--리스트 데이터 붙여넣는 영역-->
      <div id="dataList"></div>

      <!--아파트랭크 연결-->
      <div id="linkToAptrank">
        <div id = 'tab1' style="background-color: #fe4040; color:white;">아파트랭크</div>
        <div id = 'tab2' onClick='openAptrank()'>랭크:THEME</i></div>
        <div id = 'tab3' onClick='openOprank()'>오피스텔랭크</div>
        <div id = 'tab4' onClick='openAptrankBIZ()'>아파트랭크BIZ</div>
      </div>

      <!--단지 검색창 닫기 플로팅 버튼-->
      <div id="closeSearch_floating" onClick='closeSearch()'>
        <div id='closeSearch_floting_wraper'>
          <div id="closeIcon_floating"><i class="fas fa-times"></i></div>
          <div id="clostText_floating">검색닫기</div>
        </div>
      </div>
      <!--시군구 검색창 닫기 플로팅 버튼-->
      <div id="closeRegionSearch_floating" onClick='closeRegionSearch()'>
        <div id='closeSearch_floting_wraper'>
          <div id="closeIcon_floating"><i class="fas fa-times"></i></div>
          <div id="clostText_floating">검색닫기</div>
        </div>
      </div>
      <!--단지 재정렬창 닫기 플로팅 버튼-->
      <div id="closeRearrange_floating" onClick='closeRearrange()'>
        <div id='closeSearch_floting_wraper'>
          <div id="closeIcon_floating"><i class="fas fa-times"></i></div>
          <div id="clostText_floating">정렬닫기</div>
        </div>
      </div>
      <!--단지 재정렬창 닫기 플로팅 버튼-->
      <div id="closeRegionRearrange_floating" onClick='closeRegionRearrange()'>
        <div id='closeSearch_floting_wraper'>
          <div id="closeIcon_floating"><i class="fas fa-times"></i></div>
          <div id="clostText_floating">정렬닫기</div>
        </div>
      </div>

    </div>
  </div>

  <!-- Vertically centered scrollable modal -->
  <!-- Button trigger modal -->
  <!-- Modal -->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id='aptDetail'></div>
        <div id='footer'></div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="toggleModal1" tabindex="-1" aria-labelledby="toggleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="toggleModalLabel">Modal title</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id='simulDetail'></div>
        <div id='toggle1footer'></div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="toggleModal2" tabindex="-1" aria-labelledby="toggleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="toggleModalLabe2">Modal title</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id='simulResult'></div>
        <div id='toggle2footer'></div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

</body>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.8/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyA7s95oaj498XdArjo9cT_8watLVw4JK3M",
    authDomain: "aptrank-cc61b.firebaseapp.com",
    projectId: "aptrank-cc61b",
    storageBucket: "aptrank-cc61b.appspot.com",
    messagingSenderId: "987401326011",
    appId: "1:987401326011:web:8732d04a9fc69280d7489e",
    measurementId: "G-BH5DRBH380"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>


<script>
  var selectedMonth = "202211"
  var selectedRegion = "Seoul"
  var selectedSubRegion = "1168000000_Seoul_Gangnam"
  var selectedComplex = ""

  var regionName = ""
  var valueSum = 0;
  var livingSum = 0;
  var transportSum = 0;
  var infraSum = 0;
  var eduSum = 0;

  var regValueSum = 0;
  var regSupplySum = 0;
  var regPopSum = 0;
  var regJobSum = 0;
  var linked = ""
  var regionValue = ""

  var itemNum = 0;
  var aptData = "";
  var aptData_original = "";
  var sortData = "";
  var prevValue = 0;
  var regData = "";
  var regSortData = "";

  var modalState = 0;
  var searchState = 0;
  var popupHistory = [];

  var startNotice = false;
  var noticePop = false;
  var sortingPop = false;
  var alwaysSortingPop = "on";
  var regionSelection = false;

  var sales_history_price = []
  var sales_history_date = []
  var priceCharts = []

  var broswerInfo = navigator.userAgent;

  $(document).ready(function(){
    //document.cookie = "safeCookie1=foo; SameSite=Lax";
    //document.cookie = "safeCookie2=foo";
    //document.cookie = "crossCookie=bar; SameSite=None; Secure";

    Kakao.init(kakaoKey);

    // SDK 초기화 여부를 판단합니다.
    //console.log(Kakao.isInitialized());

    var option = ""
    for(i = 0 ; i < regions.length ; i++){
        option += "<option value='" + regions[i][1] + "'>" + regions[i][0] + "</option>"
    }
    $('#sido').html(option)

    var lastRegion = localStorage.getItem('lastRegion')
    var lastSubRegion = localStorage.getItem('lastSubRegion')
    var lastMonth = localStorage.getItem('lastMonth')
    var lastNoticed = localStorage.getItem('lastNoticed')
    alwaysSortingPop = localStorage.getItem('lastSortingPop')

    //var lastRegion = sessionStorage.getItem('lastRegion')
    //var lastSubRegion = sessionStorage.getItem('lastSubRegion')
    //var lastMonth = sessionStorage.getItem('lastMonth')

    const url = new URL(window.location.href)
    const urlParams = url.searchParams
    //console.log(urlParams)

    if(urlParams.has('reg')){
      //console.log(urlParams.get('reg'))
      selectedRegion = urlParams.get('reg')
    }
    else if(lastRegion != null){
      selectedRegion = lastRegion
    }

    if(urlParams.has('sub')){
      //console.log(urlParams.get('sub'))
      selectedSubRegion = urlParams.get('sub')
    }
    else if(lastSubRegion != null){
      selectedSubRegion = lastSubRegion
    }

    if(urlParams.has('mon')){
      //console.log(urlParams.get('mon'))
      selectedMonth = urlParams.get('mon')
    }
    else if(lastMonth != null){
      selectedMonth = lastMonth
    }

    if(urlParams.has('complex')){      
      selectedComplex = urlParams.get('complex')      
    }

    if(urlParams.has('sort')){      
      sortSelection = urlParams.get('sort')
      console.log("ASDFASDF")
    }
    else{
      initSorting()
    }

    $("#month").val(selectedMonth).prop("selected", true);
    $("#sido").val(selectedRegion).prop("selected", true);
    regionName = $("#sido option:selected").val();

    $('#dataList').html("");

    optionChange(selectedSubRegion)
    updateRegion()

    //var regionSubName = $("#gungu option:selected").val()

    month = selectedMonth
    //updateTable(month, regionSubName)

    $('div.modal').on('show.bs.modal', function() {
      var modal = this;
      var hash = modal.id;
      window.location.hash = hash;
      window.onhashchange = function() {
        if (!location.hash){
          $(modal).modal('hide');
        }
      }
    });

    $('div.modal').on('hidden.bs.modal', function() {
      //var hash = this.id;
      //history.replaceState('', document.title, window.location.pathname);
      
      //처음 진입 시 공지 팝업이 표시되면, 닫은 후 가중치 팝업 표시
      if(noticePop == true){     
        noticePop = false
      }

      var hash = this.id;
      history.replaceState('', document.title, window.location.pathname);

      if(startNotice == true){
        if(alwaysSortingPop != "off"){
          if(selectedRegion != 'Korea'){
            //console.log("startNotice: ", startNotice)
            //console.log("가중치 팝업 표시 : ", alwaysSortingPop)
            showSorting()
            $('#exampleModal').modal("show");
          }
        }
        startNotice = false        
      }

      if(sortingPop == true){
        blinkSorting()
        sortingPop = false
      }
    })

    if($.cookie('popCookie') != "202211"){
      startNotice = true
      showNotice()
      //초기 진입 시 공지 팝업 표시하는 경우, 변수 startNotice에 true 할당      
      $('#exampleModal').modal("show");
    }
  });

  function showWeight(){
    if(selectedRegion != 'Korea'){
      $('#weight').show()
      $('#dataList').css({'padding-top': '115px'})

      var sortName = ""
      var priceRange = ""

      if (sortSelection == "sortDefault"){ sortName = "균형잡힌" }
      if (sortSelection == "sortLiving"){ sortName = "주거우선" }
      if (sortSelection == "sortTrans"){ sortName = "교통우선" }
      if (sortSelection == "sortInfra"){ sortName = "인프라우선" }
      if (sortSelection == "sortEdu"){ sortName = "교육우선" }
      if (sortSelection == "sortCustom"){ sortName = "커스텀" }

      if(minValue == 0 && maxValue == 60){
        priceRange = "가격 전체"
      }
      else if(minValue == 0 && maxValue != 60){
        priceRange = "가격 "+ maxValue/2 +"억 이하"
      }
      else if(minValue != 0 && maxValue == 60){
        priceRange = "가격 "+ minValue/2 +"억 이상"
      }
      else{
        priceRange = "가격 "+ minValue/2 + "억~" + maxValue/2 +"억"
      }


      var weightInfo = ""
      if(sortSelection == "sortDefault"){
        weightInfo = sortName + " 가중치 (기본값)"
        weightInfo += "   |   " + priceRange
      }
      else{
        if(selectedRegion == 'Seoul' || selectedRegion == 'Incheon' || selectedRegion == 'Gyeonggi' || selectedRegion == 'Busan' || selectedRegion == 'Daegu' || selectedRegion == 'Daejeon' || selectedRegion == 'Gwangju'){
          weightInfo = sortName + " : " + "주거 " + valLiving + ", " + "교통 " + valTrans + ", " + "인프라 " + valInfra + ", " + "교육 " + valEdu
          weightInfo += "   |   " + priceRange
        }
        else{
          weightInfo = sortName + " : " + "주거 " + valLiving + ", " + "인프라 " + valInfra + ", " + "교육 " + valEdu
          weightInfo += "   " + priceRange
        }

      }
      $('#weight').html(weightInfo)
    }
    else{
      $('#weight').hide()
      $('#dataList').css({'padding-top': '96px'})
    }
  }

  function sidoChange(){
    regionSelection = true
    optionChange()
    updateRegion()
  }

  function saveLocalStorage(){
    localStorage.setItem('lastRegion', selectedRegion)
    localStorage.setItem('lastSubRegion', selectedSubRegion)
    //localStorage.setItem('lastMonth', selectedMonth)

    //sessionStorage.setItem('lastRegion', selectedRegion)
    //sessionStorage.setItem('lastSubRegion', selectedSubRegion)
    //sessionStorage.setItem('lastMonth', selectedMonth)
  }

  function scrollUp(){
    $( 'html, body' ).animate( { scrollTop : 0 }, 50 );
  }

  function optionChange(subRegion){
    selectedSubRegion = subRegion
    regionName = $("#sido option:selected").val();
    selectedRegion = regionName
    var changeItem

    if(regionName == 'Korea'){
      changeItem = inKorea
    }
    if(regionName == 'Seoul'){
      changeItem = inSeoul
    }
    if(regionName == 'Busan'){
      changeItem = inBusan
    }
    if(regionName == 'Incheon'){
      changeItem = inIncheon
    }
    if(regionName == 'Daegu'){
      changeItem = inDaegu
    }
    if(regionName == 'Gwangju'){
      changeItem = inGwangju
    }
    if(regionName == 'Daejeon'){
      changeItem = inDaejeon
    }
    if(regionName == 'Ulsan'){
      changeItem = inUlsan
    }
    if(regionName == 'Sejong'){
      changeItem = inSejong
    }
    if(regionName == 'Gyeonggi'){
      changeItem = inGyeonggi
    }
    if(regionName == 'Gangwondo'){
      changeItem = inGangwondo
    }
    if(regionName == 'Chungcheongbukdo'){
      changeItem = inChungcheongbukdo
    }
    if(regionName == 'Chungcheongnamdo'){
      changeItem = inChungcheongnamdo
    }
    if(regionName == 'Jeollabukdo'){
      changeItem = inJeollabukdo
    }
    if(regionName == 'Jeollanamdo'){
      changeItem = inJeollanamdo
    }
    if(regionName == 'Gyeongsangbukdo'){
      changeItem = inGyeongsangbukdo
    }
    if(regionName == 'Gyeongsangnamdo'){
      changeItem = inGyeongsangnamdo
    }
    if(regionName == 'Jejudo'){
      changeItem = inJejudo
    }
    $('#gungu').empty();

    for(var i = 0 ; i < changeItem.length; i++){
      var subOption = $("<option value='" + changeItem[i][1] + "'>" + changeItem[i][0] + "</option>")
      $('#gungu').append(subOption);
    }

    if(selectedSubRegion == undefined){
      $("#gungu").val(changeItem[0][1]).prop("selected", true);
      selectedSubRegion = $("#gungu option:selected").val()
    }
    else{
      $("#gungu").val(selectedSubRegion).prop("selected", true);
    }
    //updateRegion()
  }

  var monthSelect = false;

  function updateMonth(){    
    selectedMonth = $("#month option:selected").val()
    //monthSelect = true
    updateRegion()
    regionName = $("#sido option:selected").text()
    //saveLocalStorage()
  }
  function updateRegion(){
    minValue = 0;
    maxValue = 60;    
    //var selection = document.getElementById("gungu")
    selectedRegion = $("#sido option:selected").val()
    selectedSubRegion = $("#gungu option:selected").val()

    if (selectedSubRegion != "1000000000_Korea"){
      if(selectedSubRegion == "Living_Top300" || selectedSubRegion == "Trans_Top300"  || selectedSubRegion == "Infra_Top300" || selectedSubRegion == "Edu_Top300" || selectedSubRegion == "Balanced_Top300"){
        updateTopTable(selectedMonth, selectedSubRegion)
      }
      else{
        updateTable(selectedMonth, selectedSubRegion)
        regionName = $("#sido option:selected").text()
        //*************** 시작 시 가중치 팝업 표시 ********************      
        if(regionSelection != true && alwaysSortingPop == "on"){
            //console.log("POP: ", alwaysSortingPop)
            //console.log("regionSelection: ", regionSelection)
            showSorting()
            $('#exampleModal').modal("show");                        
        }
        regionSelection = false     
        //*********************************************/
      }
    }
    else{
      updateRegionTable(selectedMonth, selectedSubRegion)
    }    
    showWeight()    
  }

  function updateTable(month, region){
    //$('div.modal').modal("hide");    
    $('#sort').css("visibility", "visible")
    $('#rearrange').css("visibility", "visible")
    $('html').scrollTop(0)
    //initSorting()
    url = "https://www.aptrank.kr/" + month + "/" + region + ".json"
    $('#dataList').html("");

    $.getJSON(url, function(json) {        
        sortData = json;
    })

    $.getJSON(url, function(json) {        
        aptData_original = json;
    })

    $.getJSON(url, function(json) {
        //console.log(json);
        aptData = json;         
        //sortData = json;
        itemNum = json.data.length;
        valueSum = 0;
        livingSum = 0;
        transportSum = 0;
        infraSum = 0;
        eduSum = 0;

        for(var i = 0 ; i < itemNum ; i++){
          var aptName = aptData.data[i]["아파트명"]
          var apt_m = aptData.data[i]["전용면적(m2)"]
          var apt_p = aptData.data[i]["전용면적(평)"]

          var apt_type = aptData.data[i]["매매타입"]

          var aptAddress = aptData.data[i]["도로명주소"]
          var aptAddress2 = aptData.data[i]["법정동주소"]
          var aptValue = Math.round( aptData.data[i]["가치 총점"] * 100 ) / 100
          var house_num = aptData.data[i]["세대수"]
          var rank = aptData.data[i]["rank"].toFixed()
          var last_sales = aptData.data[i]["last_sales"].split(",")          
          var last_sales_date = last_sales[0].toString()
          var last_sales_price = last_sales[1].toString()
          var last_sales_area = last_sales[2]
          last_sales_date_short = last_sales_date.substr(2)

          valueSum += aptData.data[i]["가치 총점"]
          livingSum += aptData.data[i]["주거총점"]
          transportSum += aptData.data[i]["교통총점"]
          infraSum += aptData.data[i]["인프라총점"]
          eduSum += aptData.data[i]["학군총점"]

          //가격필터 적용 시
          if(checkPrice(last_sales[1])){

            //console.log(valueSum)

            var addon_html = "<div class='listBox' data-bs-toggle='modal' data-bs-target='#exampleModal' id='aptSelect' onClick='showDetail(" + i + ")'>";

            if(selectedMonth == "202201"){
              addon_html += "<div class='rank'>"
              addon_html += "<div class='rank'>" + rank + "위</div>";
              addon_html += "</div>"
            }
            else{
              addon_html += "<div class='rank_content'>"
              addon_html += "<div class='rank'>" + rank + "위</div>";
              if(aptData.data[i]["rank_gap"] == 0){
                addon_html += "<div class='ranksame'> -- </div>"
              }
              else if(aptData.data[i]["rank_gap"] == 9999){
                addon_html += "<div class='ranksame'> NEW! </div>"
              }
              else if(aptData.data[i]["rank_gap"] > 0){
                addon_html += "<div class='rankup'> ▲" + Math.abs(aptData.data[i]["rank_gap"]) + "</div>"
              }
              else if(aptData.data[i]["rank_gap"] < 0){
                addon_html += "<div class='rankdown'> ▼" + Math.abs(aptData.data[i]["rank_gap"]) + "</div>"
              }              

              addon_html += "</div>"
            }

            addon_html += "<div class='content'>";
            //addon_html += "<div class='apt_name'>" + aptName + " " + apt_p + "(" + apt_m + ")</div>";

            addon_html += "<div class='apt_name'>" + aptName;

            if(Number(selectedMonth) > 202203){
              if(apt_type == "아파트"){
                addon_html += "<span class='aptYear'> (" + aptData.data[i]["준공년차"] + "년차)</span></div>";
              }
              if(apt_type == "재건축"){
                addon_html += "<span class='aptYear'> (" + aptData.data[i]["준공년차"] + "년차, 재건축)</span></div>";
              }
              if(apt_type == "분양권"){
                addon_html += "<span class='aptYear'> (분양권, " + aptData.data[i]["준공년월"].substr(0, 7) + " 예정)</span></div>";
              }
              if(apt_type == "분양(예정)"){
                addon_html += "<span class='aptYear'> (분양예정)</span></div>";
              }      
            }
            else{
              addon_html += "<span class='aptYear'> (" + aptData.data[i]["준공년차"] + "년차)</span></div>";
            }

            if(house_num == null){
              addon_html += "<div class='apt_info'>" + "세대수 미정 / <span class='aptPrice'>거래 정보 없음</span></div>";
            }
            else{            
              if(last_sales_date == "1800-01-01"){
                addon_html += "<div class='apt_info'>" + house_num.toLocaleString() + "세대 / <span class='aptPrice'>거래 정보 없음</span></div>";
              }
              else{
                addon_html += "<div class='apt_info'>"+ house_num.toLocaleString() + "세대 / <span class='aptPrice'>" + Math.round(last_sales_price/100)/100 + "억, " + last_sales_area + ", " + last_sales_date_short + "</span></div>";
              }
            }

            if(Number(selectedMonth) > 202203 && (apt_type == "분양권" || apt_type == "분양(예정)")){
              addon_html += "<div class='apt_address'>" + aptData.data[i]["법정동주소"] + "</div>";
            }
            else{
              addon_html += "<div class='apt_address'>" + aptAddress2 + "</div>";
            }

            addon_html += "</div>";
            addon_html += "<div class='value_score'>" + ( Math.round( aptValue * 100 ) / 100 ).toFixed(2) + "점</div>"
            addon_html += "</div>"

            $('#dataList').append(addon_html); 
          }         
        }
        $('#dataList').append("<div style='height: 2em'></div>");
        if(!(minValue == 0 && maxValue == 60)){
          $(".aptPrice").css({'color': '#fe4040', 'font-weight': '600'})
        }

        if(sortSelection != 'sortDefault'){
          changeSort()
        }

        if(selectedComplex != ""){          
          showDetail(selectedComplex)
          $('#exampleModal').modal("show");
          selectedComplex = ""
        }
    })    
    showWeight()
    saveLocalStorage()
  }

  function showDetail(index){
    titleHtml = "";
    detailHtml = "";
    footerHtml = "";
    /*
    if(sortSelection == "sortDefault"){
      aptData = aptData_original
      var aptRank = aptData.data[index]["rank"] + "/" + aptData.data[itemNum-1]["rank"] + "위"
    }
    else{
      aptData = sortData
      var aptRank = (index+1) + "/" + aptData.data[itemNum-1]["rank"] + "위"
    }
    */

    aptData = sortData
    var aptRank = (Number(index)+1) + "/" + aptData.data[itemNum-1]["rank"] + "위"

    var aptName = aptData.data[index]["아파트명"]
    var apt_m = aptData.data[index]["전용면적(m2)"]
    var apt_p = aptData.data[index]["전용면적(평)"]
    var apt_type = aptData.data[index]["매매타입"]
    var aptAddress = aptData.data[index]["도로명주소"]
    var aptValue = Math.round( aptData.data[index]["가치 총점"] * 100 ) / 100;
    var aptDuration = aptData.data[index]["준공년차"]
    var aptYear = ""
    var short_name = $('#sido option:selected').text() + " " + $('#gungu option:selected').text()

    gtag('event','아파트상세', { 'event_category' : short_name, 'event_label' : aptName + "(" + short_name + ")"});

    if(Number(selectedMonth) > 202203){      
      if(apt_type == "아파트"){        
        aptYear = aptData.data[index]["준공년월"] + " (" + aptDuration + "년차)"        
      }
      if(apt_type == "재건축"){        
        aptYear = aptData.data[index]["준공년월"] + " (" + aptDuration + "년차, 재건축)"        
      }
      if(apt_type == "분양권"){
        aptYear = "(분양권, " + aptData.data[index]["준공년월"].substr(0, 7) + " 예정)"        
      }
      if(apt_type == "분양(예정)"){
        aptYear = "(분양예정)"        
      }      
    }
    else{
      if(aptDuration >= 30){
        aptYear = aptData.data[index]["준공년월"] + " (" + aptDuration + "년차, 재건축 대상)"
      }else{
        aptYear = aptData.data[index]["준공년월"] + " (" + aptDuration + "년차)"
      }
    }

    var nearestStation = aptData.data[index]["가까운역이름"] + "역" + "(" + ( Math.round( aptData.data[index]["가까운역거리"] * 100 ) / 100 ).toFixed()  + "m)"
    var stationArea = aptData.data[index]["역세권여부"]
    var stationPoint_30m = aptData.data[index]["30분이내주요거점역"]
    var stationPoint_1h = aptData.data[index]["1시간이내주요거점역"]
    var departmentStore_3km = aptData.data[index]["3km이내백화점수"] + "개"
    var OutletMall_5km = aptData.data[index]["5km이내아울렛몰수"] + "개"
    var bigMart_1km = aptData.data[index]["1km이내대형먀트수"] + "개"
    var bank_500m = aptData.data[index]["500m이내은행수"] + "개"
    var hospital_500m = aptData.data[index]["500m이내병원수"] + "개"
    var bigHospital_5km = aptData.data[index]["5km이내대형병원수"] + "개"
    var park_500m = aptData.data[index]["500m이내공원수"] + "개"
    var big_park_1km = aptData.data[index]["800m이내대형공원수"] + "개"
    var harmful_3km = aptData.data[index]["3km이내혐오시설수"] + "개"
    var pSchool_edu = aptData.data[index]["초등학교학업성취도"]
    var pSchool_distance = aptData.data[index]["초등학교거리"]
    var mSchool_edu = aptData.data[index]["중학교학업성취도"] + "%"
    var academy_edu = aptData.data[index]["500m이내학원가"] + "개" + "(총 " + aptData.data[index]["500m이내학원수"] + "개 학원)"
    var market_infra = aptData.data[index]["300m이내상권"] + "개" + "(총 " + aptData.data[index]["300m이내점포수"] + "개 지점)"
    var livingScore = ( Math.round( aptData.data[index]["주거총점"] * 100 ) / 100 ).toFixed(2)
    var transportScore = ( Math.round( aptData.data[index]["교통총점"] * 100 ) / 100 ).toFixed(2)
    var infraScore = ( Math.round( aptData.data[index]["인프라총점"] * 100 ) / 100 ).toFixed(2)
    var eduScore = ( Math.round( aptData.data[index]["학군총점"] * 100 ) / 100 ).toFixed(2)
    var area_info = aptData.data[index]["area_info"]
    if(Number(selectedMonth) > 202203){
      var maintainance = aptData.data[index]["maintenance"]
    }
    var rooms = aptData.data[index]["room"]
    var baths = aptData.data[index]["bath"]
    var house_num = aptData.data[index]["세대수"]
    var parking = aptData.data[index]["주차"]
    var heating = aptData.data[index]["난방"]
    var entrance = aptData.data[index]["현관구조"]
    var sales_info = aptData.data[index]["sales_info"]
    var price_per = aptData.data[index]["price_per"]
    var floor_noise = aptData.data[index]["층간소음"]

    var searchCode = aptData.data[index]["검색코드"]
    var coord_y = aptData.data[index]["Y"]
    var coord_x = aptData.data[index]["X"]

    var drink_pub = aptData.data[index]["300m이내유흥주점"]
    var daran_pub = aptData.data[index]["300m이내단란주점"]
    var motel = aptData.data[index]["300m이내모텔"]

    var last_sales = aptData.data[index]["last_sales"].split(",")
    var last_sales_date = last_sales[0].toString()
    var last_sales_price = last_sales[1].toString()
    var last_sales_area = last_sales[2]

    if(Number(selectedMonth) > 202207){
      var rent_info = aptData.data[index]["rent_info"]
      var rent_ratio = aptData.data[index]["rent_ratio"]
      var last_rent = aptData.data[index]["last_rent"].split(",")
      var last_rent_date = last_rent[0].toString()
      var last_rent_price = last_rent[1].toString()
      var last_rent_area = last_rent[2]
    }

    var floor_rate = ""
    if(aptData.data[index]["용적률"] == "0"){
      floor_rate = "--%"
    }
    else{
      floor_rate = aptData.data[index]["용적률"] + "%"
    }

    var cover_rate = ""
    if(aptData.data[index]["건폐율"] == "0"){
      cover_rate = "--%"
    }
    else{
      cover_rate = aptData.data[index]["건폐율"] + "%"
    }

    var populationScore = Math.round( aptData.data[index]["인구총점"] * 100 ) / 100
    var jobScore = Math.round( aptData.data[index]["일자리총점"] * 100 ) / 100

    //타이틀
    //titleHtml += "<div class='popupTitle'>" + aptName + " " + apt_p + "(" + apt_m + ")</div>";
    //titleHtml += "<div class='popupTitle'><a href='#' onclick='return false;' style='text-decoration: none; color: black'>" + aptName + "</a></div>";
    titleHtml += "<div class='popupTitle'><h1 style='font-size: 1em; font-weight: 600'>" + aptName + "</h></div>";
    titleHtml += "<div class='popupSubtitle'>" + aptYear + "</div>";

    if(Number(selectedMonth) > 202203 && (apt_type == "분양권" || apt_type == "분양(예정)")){
      titleHtml += "<div class='popupSubtitle'>" + aptData.data[index]["법정동주소"] + "</div>";
    }
    else{
      titleHtml += "<div class='popupSubtitle' style='font-size: 0.6em'>(신) " + aptAddress + "</div>";
      titleHtml += "<div class='popupSubtitle' style='font-size: 0.6em'>(구) " + aptData.data[index]["법정동주소"] + "</div>";
    }    

    //총점,순위
    detailHtml += "<div class='card'>";
    detailHtml += "<div class='card-header'>";

     var sortName = ""

    if (sortSelection == "sortDefault"){ sortName = "균형잡힌" }
    if (sortSelection == "sortLiving"){ sortName = "주거우선" }
    if (sortSelection == "sortTrans"){ sortName = "교통우선" }
    if (sortSelection == "sortInfra"){ sortName = "인프라우선" }
    if (sortSelection == "sortEdu"){ sortName = "교육우선" }
    if (sortSelection == "sortCustom"){ sortName = "커스텀" }

    if(rearrangeAPTSelection == "rearrangeRank"){ sortName = "순위변동순" }    
    if(rearrangeAPTSelection == "rearrangePrice"){ sortName = "실거래가순" }    
    if(rearrangeAPTSelection == "rearrangeNew"){ sortName = "신축순" }
    if(rearrangeAPTSelection == "rearrangeHouse"){ sortName = "세대수순" }


      detailHtml += "<div class='popupSubtitle' style='font-size: 0.75em; text-align: center'>- " + $('#sido option:selected').text() + " " + $('#gungu option:selected').text() + " -</div>"

      if(selectedMonth == "202201"){
        detailHtml += "<div class='popRank'><i class='fas fa-trophy'></i> " + aptRank + "</div></div>";
      }
      else{
        detailHtml += "<div class='popRank'><i class='fas fa-trophy'></i> " + aptRank;

        if(sortSelection == "sortDefault" && (rearrangeAPTSelection == "rearrangeScore" || rearrangeAPTSelection == "rearrangeRank")){
          if(aptData.data[index]["rank_gap"] == 0){
            detailHtml += "<span class='ranksame'> (--) </span>"
          }
          else if(aptData.data[index]["rank_gap"] == 9999){
            detailHtml += "<span class='ranksame'> (NEW!) </span>"
          }
          else if(aptData.data[index]["rank_gap"] > 0){
            detailHtml += "<span class='rankup'> (▲" + Math.abs(aptData.data[index]["rank_gap"]) + ")</span>"
          }
          else if(aptData.data[index]["rank_gap"] < 0){
            detailHtml += "<span class='rankdown'>(▼" + Math.abs(aptData.data[index]["rank_gap"]) + ")</span>"
          }
        }
        else{
          detailHtml += "<span class='ranksame'>(" + sortName + ") </span>"
        }                
        detailHtml += "</div></div>"
      }

    detailHtml += "<div class='card-body' style='padding-top: 2px'>";    
    detailHtml += "<div class='graph' style='height: 200px'> <canvas id='valueChart'></canvas></div>"
    detailHtml += "<div class='comment'>(지역구의 모든 단지에 대해 100점으로 환산한 상대 점수 입니다.)</div>";
    if(Number(selectedMonth) > 202203){
      detailHtml += "<hr style='margin-bottom: 0'><div class='rankGraphTitle'>- 균형잡힌 가중치 순위 변동 -</div><div class='graph' style='height: 120px;'> <canvas id='rankChart'></canvas></div>"
    }
    /*
    if(Number(selectedMonth) > 202205){
      detailHtml += "<div id='rankSimul' onclick='openSimulation(aptData.data," + index + ")'>랭크 시뮬레이션 <span style='font-size: 0.8em; outline: 1px solid white; border-radius: 10px; padding: 0px 7px 0px 7px'> BETA </span></div>"
    }
    */
    if(Number(selectedMonth) > 202206){      
      detailHtml += "<hr>"
      detailHtml += "<div class='popupSubtitle' style='text-align: center; margin-top: 10px'>↓↓ 내 생각과 다르다면, 데이터를 바꿔 보세요! ↓↓</div>"
      detailHtml += "<div id='rankSimul' style='margin-top: 1px; margin-bottom: 10px' onclick='openSimulation(aptData.data," + index + ")'>랭크 시뮬레이션 <span style='font-size: 0.8em; outline: 1px solid white; border-radius: 10px; padding: 0px 7px 0px 7px'> BETA </span></div>"      
    }
    detailHtml += "</div></div>"

    //주거
    detailHtml += "<div class='card'>";
    detailHtml += "<div class='card-header'>";
    detailHtml += "<div class='popTitle'><i class='fas fa-home'></i>&nbsp&nbsp주거</div>"
    detailHtml += "</div>";
    detailHtml += "<div class='card-body'>";
    detailHtml += "<div id='popLiving'>"
    detailHtml += "<div class='graph' style='height: 120px'> <canvas id='livingChart'></canvas></div>"
    detailHtml += "<div class='popTable'>"
    if(Number(selectedMonth) > 202205 && aptData.data[index]["한강"] > 0){
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "한강 프리미엄" + "</div>" + "<div class='popResult'>적용</div></div>";
    }    
    if(Number(selectedMonth) > 202205 && aptData.data[index]["해운대"] > 0){
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "해운대 프리미엄" + "</div>" + "<div class='popResult'>적용</div></div>";
    }    

    if(house_num != null){
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "세대수" + "</div>" + "<div class='popResult'>" + house_num.toLocaleString() + "세대</div></div>";
    }
    else{
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "세대수" + "</div>" + "<div class='popResult'>미정</div></div>";
    }
    
    if(Number(selectedMonth) > 202203){
      if(apt_type >= "재건축"){
        detailHtml += "<div class='popSubTable'><div class='popContent'>" + "용적률" + "</div>" + "<div class='popResult'>" + floor_rate + "</div></div>";
        detailHtml += "<div class='popSubTable'><div class='popContent'>" + "건폐율" + "</div>" + "<div class='popResult'>" + cover_rate + "</div></div>";
      }
    }
    else{
      if(aptDuration >= 30){
        detailHtml += "<div class='popSubTable'><div class='popContent'>" + "용적률" + "</div>" + "<div class='popResult'>" + floor_rate + "</div></div>";
        detailHtml += "<div class='popSubTable'><div class='popContent'>" + "건폐율" + "</div>" + "<div class='popResult'>" + cover_rate + "</div></div>";
      }
    }
    if(Number(selectedMonth) > 202203){
      detailHtml += "<div class='popSubTable' id='popSubStation'><div class='popContent'>" + "주차" + "</div>" + "<div class='popResult'>" + parking + "</div></div>";
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "난방방식" + "</div>" + "<div class='popResult'>" + heating + "</div></div>";
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "현관구조" + "</div>" + "<div class='popResult'>" + entrance + "</div></div>";
    }

    console.log(apt_type)

    if(Number(selectedMonth) > 202203){
      if(apt_type == "분양(예정)"){}
      else{
        var area_array = area_info.split(",")
        var maintainance_array = maintainance.split(",")
        var rooms_array = rooms.split(",")
        var baths_array = baths.split(",")
        detailHtml += "<div class='table-responsive' style='max-height: 200px; overflow-y: scroll'>"
        detailHtml += "<table class='table table-striped' style='font-size:0.8em'>"
          detailHtml += "<thead class='table-light' style='position:sticky ;top: 0'>"
            detailHtml += "<tr>"
              detailHtml += "<th scope='col'>" + "평형" + "</th>"
              detailHtml += "<th scope='col'>" + "방수/욕실수" + "</th>"
              detailHtml += "<th scope='col'>" + "평균 관리비" + "</th>"
            detailHtml += "</tr>"
          detailHtml += "</thead>"

          detailHtml += "<tbody>"
              for(var k = 0 ; k < area_array.length ; k++){
                detailHtml += "<tr>"
                  detailHtml += "<td>" + area_array[k] + "</td>"
                  detailHtml += "<td>" + parseInt(rooms_array[k]) + " / " + parseInt(baths_array[k]) + "</td>"
                  if(isNaN(maintainance_array[k]) == true ){
                    detailHtml += "<td>" + "---" + "</td>"
                  }
                  else{
                    detailHtml += "<td>" + Number(maintainance_array[k]).toLocaleString() + "원" + "</td>"
                  }
                detailHtml += "</tr>"
              }
          detailHtml += "</tbody>"
        detailHtml += "</table>"
        detailHtml += "</div>"
        }
    }
    else{
      detailHtml += "<div id='popSubLiving'><div class='popContent'>" + "면적 구성" + "<br>" + "<span class='popResult'>" + area_info + "</span></div></div>";
    }
    detailHtml += "<div class='comment2'>주거총점 계산을 위한 정보는 네이버 부동산으로 취득하며, 세대수/평형/난방방식 등의 항목을 상대점수로 산정합니다.</div>"
    detailHtml += "</div></div></div></div>"
    avgLivingScore = Math.round( livingSum/itemNum * 100 ) / 100

    if(Number(selectedMonth) > 202207 && apt_type != "분양(예정)"){
      //층간소음
      detailHtml += "<div class='card'>";
      detailHtml += "<div class='card-header'>";
      detailHtml += "<div class='popTitle'><i class='fa-solid fa-bell-slash'></i>&nbsp&nbsp층간소음</div>"
      detailHtml += "</div>";
      detailHtml += "<div class='card-body' style='padding-top: 5px'>";
      detailHtml += "<div id='popLiving'>"    
      detailHtml += "<div class='popTable'>"

      noise_level = ""
              
      if(floor_noise == "좋음" || floor_noise == "우수" ){
        noise_level = "<span style='color:#148523'><i class='fa-solid fa-face-laugh'></i>     " + "우수" + "</span>"
      }
      else if (floor_noise == "보통"){
        noise_level = "<span style='color:#148185'><i class='fa-solid fa-face-smile'></i>     " + floor_noise + "</span>"
      }
      else{
        noise_level = "<span style='color:black'>" + "정보 없음" + "</span>"
      }

      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "층간소음 관리" + "</div>" + "<div class='popResult'>" + noise_level + "</div></div>";
      detailHtml += "<div class='comment2' style='font-size: 0.7em'>층간소음 관리 정보는 층간소음 전문 연구소 <span style='color:#4542f5; font-weight:600'>주거문화개선연구소/층간소음에 안전한 아파트(앱)</span>에서 제공됩니다.</div>"
      detailHtml += "</div></div></div></div>"    
    }

    if(isNaN(transportScore) == false){
      //교통
      detailHtml += "<div class='card'>";
      detailHtml += "<div class='card-header'>";
      detailHtml += "<div class='popTitle'><i class='fas fa-bus'></i>&nbsp&nbsp교통</div>"
      detailHtml += "</div>";
      detailHtml += "<div class='card-body'>";
      detailHtml += "<div id='popTransport'>"
      detailHtml += "<div class='graph' style='height: 120px'> <canvas id='transportChart'></canvas></div>"
      detailHtml += "<div class='popTable'>"
      detailHtml += "<div class='popSubTable' id='popSubStation'><div class='popContent'>" + "가장 가까운 역" + "</div>" + "<div class='popResult'>" + nearestStation + "</div></div>";

      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "30분 이내 도착 가능 주요역" + "</div>" + "<div class='popResult'>" + stationPoint_30m + "개</div></div>";
      if(stationPoint_30m != 0 && selectedMonth != "202201"){
        var stations_30m = aptData.data[index]["30분거점역이름"]
        stations_30m = ( ( stations_30m.replace("[", "") ).replace("]", "") ).replace(/\'/g, "")
        detailHtml += "<div class='stationList'><div></div><div class='stationText'>" + stations_30m + "</div></div>";
      }

      detailHtml += "<div class='popSubTable' id='stationTable'><div class='popContent'>" + "1시간 이내 도착 가능 주요역" + "</div>" + "<div class='popResult'>" + stationPoint_1h + "개</div></div>";
      if(stationPoint_1h != 0 && selectedMonth != "202201"){
        var stations_1h = aptData.data[index]["1시간거점역이름"]
        stations_1h = stations_1h.replace("[", "").replace("]", "").replace(/\'/g, "")
        detailHtml += "<div class='stationList'><div></div><div class='stationText'>" + stations_1h + "</div></div><hr style='margin-top: 2px'>";
      }

      detailHtml += "<div class='comment2'>가장 가까운 역은 직선거리로 계산됩니다.<br>주요역은 평일 출근시간대 하차인원이 가장 많은 역을 의미합니다.<br>30분, 1시간 이동 거리는 구글 대중교통 이동 시간 정보를 사용합니다.</div>"
      detailHtml += "</div></div></div></div>"
      avgTransportScore = ( Math.round( transportSum/itemNum * 100 ) / 100 ).toFixed(2)
    }

    //인프라
    detailHtml += "<div class='card'>";
    detailHtml += "<div class='card-header'>";
    detailHtml += "<div class='popTitle'><i class='fas fa-hospital-user'></i>&nbsp&nbsp인프라</div>"
    detailHtml += "</div>";
    detailHtml += "<div class='card-body'>";
    detailHtml += "<div id='popInfra'>"
    detailHtml += "<div class='graph' style='height: 120px'> <canvas id='infraChart'></canvas></div>"
    detailHtml += "<div class='popTable'>"    
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "3km 이내 백화점" + "</div>" + "<div class='popResult'>" + departmentStore_3km + "</div></div>";
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "5km 이내 아울렛/몰" + "</div>" + "<div class='popResult'>" + OutletMall_5km + "</div></div>";
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "1km 이내 대형마트" + "</div>" + "<div class='popResult'>" + bigMart_1km + "</div></div>";
    if(Number(selectedMonth) > 202204){
      if(aptData.data[index]["300m이내상권"] == '0'){
        detailHtml += "<div class='popSubTable'><div class='popContent'>" + "300m 이내 상권" + "</div>" + "<div class='popResult'>0개</div></div>";
      }
      else{
        detailHtml += "<div class='popSubTable'><div class='popContent'>" + "300m 이내 상권" + "</div>" + "<div class='popResult'>" + market_infra + "</div></div>";
      }
    }
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "500m 이내 은행" + "</div>" + "<div class='popResult'>" + bank_500m + "</div></div>";
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "500m 이내 병원" + "</div>" + "<div class='popResult'>" + hospital_500m + "</div></div>";
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "5km 이내 대형병원" + "</div>" + "<div class='popResult'>" + bigHospital_5km + "</div></div>";
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "500m 이내 공원" + "</div>" + "<div class='popResult'>" + park_500m + "</div></div>";
    if(Number(selectedMonth) > 202205){
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "1km 이내 대형공원" + "</div>" + "<div class='popResult'>" + big_park_1km + "</div></div>";
    }
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "3km 이내 혐오시설" + "</div>" + "<div class='popResult'>" + harmful_3km + "</div></div>";
    if(Number(selectedMonth) > 202204){      
      detailHtml += "<div class='comment2'>인프라 정보는 각 백화점/마트 홈페이지, 은행연합회, 자원순환정보시스템, 공공데이터 포탈의 정보를 기반으로 산정되며, 상권은 호갱노노 정보를 사용합니다.</div>"
    }
    else{
      detailHtml += "<div class='comment2'>인프라 정보는 각 백화점/마트 홈페이지, 은행연합회, 자원순환정보시스템, 공공데이터 포탈의 정보를 기반으로 산정됩니다.</div>"
    }
    detailHtml += "</div></div></div></div>"
    avgInfraScore = ( Math.round( infraSum/itemNum * 100 ) / 100 ).toFixed(2)

    //교육
    detailHtml += "<div class='card'>";
    detailHtml += "<div class='card-header'>";
    detailHtml += "<div class='popTitle'><i class='fas fa-graduation-cap'></i>&nbsp&nbsp교육</div>"
    detailHtml += "</div>";
    detailHtml += "<div class='card-body'>";
    detailHtml += "<div id='popEducation'>"
    detailHtml += "<div class='graph' style='height: 120px'> <canvas id='eduChart'></canvas></div>"
    detailHtml += "<div class='popTable'>"
    if(Number(selectedMonth) > 202204){
      if(pSchool_distance-100 < 0){
        minDistance = parseInt(pSchool_distance*0.8)
      }
      else{
        minDistance = parseInt(pSchool_distance - 100)
      }
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "초등학교 거리" + "</div>" + "<div class='popResult'>" + minDistance + "~" + parseInt(pSchool_distance) + "m</div></div>";      
    }

    if(pSchool_edu > 95 && pSchool_edu <= 100 ){
      pSchool_edu_result = "많은 전입"
    }
    else if(pSchool_edu >= 92 && pSchool_edu <= 95 ){
      pSchool_edu_result = "적은 전입"
    }
    else if(pSchool_edu >= 88 && pSchool_edu < 92 ){
      pSchool_edu_result = "전입/전출 적음"
    }
    else if(pSchool_edu >= 85 && pSchool_edu < 88 ){
      pSchool_edu_result = "적은 전출"
    }
    else{
      pSchool_edu_result = "많은 전출"
    }
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "초등학교 학생증감" + "</div>" + "<div class='popResult'>" + pSchool_edu_result + "</div></div>";
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "중학교 보통 학력 이상" + "</div>" + "<div class='popResult'>" + mSchool_edu + "</div></div>";
    if(Number(selectedMonth) > 202204 && Number(selectedMonth) <= 202206){
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "500m 이내 학원가" + "</div>" + "<div class='popResult'>" + academy_edu + "</div></div>";
      detailHtml += "<div class='comment2'>교육 정보는 교육통계서비스 정보를 기반으로 산정되며, 학원가는 호갱노노의 정보를 사용합니다.<br>초등학교까지의 거리는 직선거리로 계산됩니다.</div>"
    }
    else if(Number(selectedMonth) > 202206){
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "500m 이내 학원가" + "</div>" + "<div class='popResult'>" + academy_edu + "</div></div>";
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "300m 이내 유흥시설/모텔" + "</div>" + "<div class='popResult'>" + (drink_pub + daran_pub + motel) + "개</div></div>";
      detailHtml += "<div class='comment2'>교육 정보는 교육통계서비스 정보를 기반으로 산정되며,<br>학원가는 호갱노노의 정보를 사용합니다.<br>초등학교까지의 거리는 직선거리로 계산됩니다.<br>유흥시설과 모텔정보는 교육 감점요소로 적용됩니다.</div>"
    }
    else{
      detailHtml += "<div class='comment2'>교육 정보는 교육통계서비스 정보를 기반으로 산정됩니다.</div>"
    }    
    detailHtml += "</div></div></div></div>"
    avgEduScore = ( Math.round( eduSum/itemNum * 100 ) / 100 ).toFixed(2)

    //실거래가
    if(Number(selectedMonth) > 202207){
      var rent_info_array = rent_info.split(",")
      var rent_ratio_array = rent_ratio.split(",")
    }

    if(Number(selectedMonth) > 202203 && apt_type != "분양(예정)"){
      var sales_info_array = sales_info.split(",")
      var price_per_array = price_per.split(",")

      detailHtml += "<div class='card'>";
      detailHtml += "<div class='card-header'>";
      detailHtml += "<div class='popTitle'><i class='fa-solid fa-coins'></i>&nbsp&nbsp실거래가 <span style='font-size: 0.7em; color:#fe4040'> (최근 1개월내 실거래는 빨간색으로 표시)</span> </div>"
      detailHtml += "</div>";
      detailHtml += "<div class='card-body' style='padding-left: 5px ; padding-right: 5px; padding-top: 5px;'>";
      detailHtml += "<div id='popEducation'>"
      detailHtml += "<div class='popTable'>"
      detailHtml += "<div id='popSubStation' style='grid-template-columns: 0.3fr 1fr; margin-left: 5px ; margin-right: 5px; margin-top: 10px;'>"
      detailHtml += "<div class='popContent'>최근 실거래</div>"

      //var current_year = selectedMonth.substr(0, 4)
      //var current_month = selectedMonth.substr(4, 2) - 1
      //var current_day = "01"
      var start_date = new Date()
      start_date.setMonth(start_date.getMonth() - 1)      

      if(isNaN(last_sales_price)){
        detailHtml += "<div class='popResult'>거래 정보 없음</div></div>"
      }
      else{
        var compare_year = Number(last_sales_date.substr(0, 4))
        var compare_month = Number(last_sales_date.substr(5, 2) - 1)
        var compare_day = Number(last_sales_date.substr(8, 2))
        var compare_date = new Date(compare_year, compare_month, compare_day)        

        if(compare_date > start_date){
          detailHtml += "<div class='popResult' style='color: #fe4040'>" + last_sales_area + ", " + Math.round(last_sales_price/100)/100 + "억, "+ last_sales_date.substr(2) + "</div></div>"
        }
        else{
          detailHtml += "<div class='popResult'>" + last_sales_area + ", " + Math.round(last_sales_price/100)/100 + "억, "+ last_sales_date.substr(2) + "</div></div>"
        }

      }
      detailHtml += "<hr>"
      detailHtml += "<table class='table table-striped' style='font-size:0.8em'>"
        detailHtml += "<thead class='table-light'>"
          detailHtml += "<tr>"
            if(Number(selectedMonth) > 202207){
              detailHtml += "<th scope='col' style='line-height: 2.9em;'>" + "평형" + "</th>"
              detailHtml += "<th scope='col'>" + "매매 실거래가<br>전세 실거래가" + "</th>"
              detailHtml += "<th scope='col'>" + "평단가<br>전세가율" + "</th>"
            }
            else{
              detailHtml += "<th scope='col'>" + "평형" + "</th>"
              detailHtml += "<th scope='col'>" + "실거래가" + "</th>"
              detailHtml += "<th scope='col'>" + "평단가" + "</th>"
            }
          detailHtml += "</tr>"
        detailHtml += "</thead>"

        detailHtml += "<tbody>"
            for(var k = 0 ; k < area_array.length ; k++){
              detailHtml += "<tr>"
                if(sales_info_array[k] == "거래 정보 없음"){
                  if(Number(selectedMonth) > 202207){
                    detailHtml += "<td>" + area_array[k] + "</td>"
                    detailHtml += "<td>" + "거래 정보 없음" + "<br>"
                    if(rent_ratio_array[k] == "정보 없음" ){
                      detailHtml += "거래 정보 없음</td>"
                    }
                  }
                  else{
                    detailHtml += "<td>" + area_array[k] + "</td>"
                    detailHtml += "<td>" + "거래 정보 없음" + "</td>"
                  }
                }
                else{                  
                  var sales_info_split = sales_info_array[k].split("억")                  
                  var compare_year = Number(sales_info_split[1].substr(2, 4))
                  var compare_month = Number(sales_info_split[1].substr(7, 2)-1)
                  var compare_day = Number(sales_info_split[1].substr(10, 2))
                  var compare_date = new Date(compare_year, compare_month, compare_day)

                  if(Number(selectedMonth) > 202207){
                    var rent_info_split = rent_info_array[k].split("억")
                    if(rent_info_split[0] == "거래 정보 없음"){
                      
                    }
                    else{                    
                      var compare_rent_year = Number(rent_info_split[1].substr(2, 4))
                      var compare_rent_month = Number(rent_info_split[1].substr(7, 2) - 1)
                      var compare_rent_day = Number(rent_info_split[1].substr(10, 2))
                      var compare_rent_date = new Date(compare_rent_year, compare_rent_month, compare_rent_day)
                    }

                    if(compare_date > start_date){
                      detailHtml += "<td><span style='color:#fe4040; font-weight:600'>" + area_array[k] + "</span></td>"
                      detailHtml += "<td><span style='color:#fe4040; font-weight:600'>" + ( Math.round( sales_info_split[0] * 100 ) / 100 ).toFixed(2) + "억" + "<span style='font-size: 0.85em'>" + sales_info_split[1] + "</span></span><br>"
                    }
                    else{
                      detailHtml += "<td>" + area_array[k] + "</td>"
                      detailHtml += "<td>" + ( Math.round( sales_info_split[0] * 100 ) / 100 ).toFixed(2) + "억" + "<span style='font-size: 0.85em'>" + sales_info_split[1] + "</span><br>"
                    }

                    if(compare_rent_date > start_date){
                      if(rent_info_split[0] == "거래 정보 없음"){
                        detailHtml += "거래 정보 없음</td>"
                      }
                      else{
                        detailHtml += "<span style='color:#fe4040; font-weight:600'>" + ( Math.round( rent_info_split[0] * 100 ) / 100 ).toFixed(2) + "억" + "<span style='font-size: 0.85em'>" + rent_info_split[1] + "</span></span></td>"
                      }
                    }
                    else{         
                      if(rent_info_split[0] == "거래 정보 없음"){
                        detailHtml += "거래 정보 없음</td>"
                      }
                      else{
                        detailHtml += "" + ( Math.round( rent_info_split[0] * 100 ) / 100 ).toFixed(2) + "억" + "<span style='font-size: 0.85em'>" + rent_info_split[1] + "</span></td>"
                      }
                    }
                  }
                  else{
                    if(compare_date > start_date){
                      detailHtml += "<td><span style='color:#fe4040; font-weight:600'>" + area_array[k] + "</span></td>"
                      detailHtml += "<td><span style='color:#fe4040; font-weight:600'>" + ( Math.round( sales_info_split[0] * 100 ) / 100 ).toFixed(2) + "억" + "<span style='font-size: 0.85em'>" + sales_info_split[1] + "</span></span></td>"
                    }
                    else{
                      detailHtml += "<td>" + area_array[k] + "</td>"
                      detailHtml += "<td>" + ( Math.round( sales_info_split[0] * 100 ) / 100 ).toFixed(2) + "억" + "<span style='font-size: 0.85em'>" + sales_info_split[1] + "</span></td>"
                    }                    
                  }                  
                }

                if(Number(selectedMonth) > 202207){
                  if(price_per_array[k] == "nan" || price_per_array[k] == 0){
                  detailHtml += "<td>" + "---" + "<br>"
                  }
                  else{
                    if(compare_date > start_date){
                      detailHtml += "<td><span style='color:#fe4040; font-weight:600'>" + Number(price_per_array[k]).toLocaleString() + "만원" + "</span><br>"
                    }
                    else{
                      detailHtml += "<td>" + Number(price_per_array[k]).toLocaleString() + "만원<br>"
                    }
                  }

                  if(rent_ratio_array[k] == "정보 없음"){
                    detailHtml += "---" + "</td>"
                  }
                  else{
                    if(compare_rent_date > start_date){
                      detailHtml += "<span style='color:#fe4040; font-weight:600'>" + (Math.round( rent_ratio_array[k] * 100 ) / 100 ).toFixed(2) + "%" + "</span></td>"
                    }
                    else{
                      detailHtml += (Math.round( rent_ratio_array[k] * 100 ) / 100 ).toFixed(2) + "%" + "</td>"
                    }
                  }
                }
                else{
                  if(price_per_array[k] == "nan" ){
                    detailHtml += "<td>" + "---" + "</td>"
                  }
                  else{
                    if(compare_date > start_date){
                      detailHtml += "<td><span style='color:#fe4040; font-weight:600'>" + Number(price_per_array[k]).toLocaleString() + "만원" + "</span></td>"
                    }
                    else{
                      detailHtml += "<td>" + Number(price_per_array[k]).toLocaleString() + "만원" + "</td>"
                    }
                  }
                }              

              detailHtml += "</tr>"
            }
        detailHtml += "</tbody>"
      detailHtml += "</table>"
      detailHtml += "<div class='comment2'>&nbsp&nbsp실거래가 정보는 네이버 부동산으로 취득합니다.</div>"
      detailHtml += "</div></div></div></div>"
    }

    if(Number(selectedMonth) > 202209 && apt_type != "분양(예정)"){
      //매매 실거래가
      detailHtml += "<div class='card'>";
      detailHtml += "<div class='card-header'>";
        detailHtml += "<div class='popPriceTitle'><i class='fa-solid fa-chart-line'></i>&nbsp&nbsp매매가변동<span id='themeLogo'>BETA</span></div>"
      detailHtml += "</div>"

      detailHtml += "<div class='card-body' style='padding-top: 5px; padding-left: 5px; padding-right: 5px;'>";
      detailHtml += "<div class='priceHistoryOption'>"        
        detailHtml += "<div style='text-align:left; padding-left:10px'><input type='checkbox' id='showGraph' checked='true' onChange='graphShowHide(this)' style='width: 0.8em; height: 0.8em'>"
          detailHtml += "<label for='showGraph' style='font-size: 0.85em; padding-left: 3px'>그래프보기</label></input></div>"
        detailHtml += "<div style='text-align: right'><select id='pStart' onChange='price_sDateChange(this)'></select> - <select id='pEnd' onChange='price_eDateChange(this)'></select></div>"
      detailHtml += "</div>"
      detailHtml += "<div id='popEducation'>"
      detailHtml += "<div class='popTable'>"
      
      sales_history_price = aptData.data[index]["sales_history_price"]
      if(sales_history_price[0][0] == undefined){
        sales_history_price = [sales_history_price]
      }
      sales_history_date = aptData.data[index]["매매실거래날짜목록"]
      //console.log(sales_history_price)

      priceCharts = []
      for (var p = 0 ; p < area_array.length ; p++){
        generatedID = "pChart" + p
        generated_priceID = "pChange" + p
        generated_ratioID = "pRatio" + p

        //console.log(sales_history_price[p])
        if(Math.max(...sales_history_price[p]) <= 0){ showGraph = false }
        else{ showGraph = true }

        detailHtml += "<div class='popSubPriceTable' style='background: #eee'>"
          detailHtml += "<div class='priceResult' style='padding-left: 5px'>" + area_array[p] + "</div>"
          detailHtml += "<div class='popSubPriceTableDetail'>"
            if(showGraph){
              detailHtml += "<div class='priceResult' style='text-align: right; padding-right: 4px'><span id=" + generated_priceID + "></span>" + "</div>"
              detailHtml += "<div class='priceResult' style='text-align: right; padding-right: 8px'><span id=" + generated_ratioID + "></span>" + "</div>"            
            }
            else{
              detailHtml += "<div class='priceResult' style='text-align: right; padding-right: 4px'>거래 정보 없음" + "</div>"
              detailHtml += "<div class='priceResult' style='text-align: right; padding-right: 8px'>( --- , --- )</div>"            
            }
          detailHtml += "</div>";
        detailHtml += "</div>"

        detailHtml += "<div class='priceGraph' style='height: 100px; border-bottom: 1px solid #ddd'> <canvas id=" + generatedID + "></canvas></div>"
        priceCharts.push(generatedID)    
      }    
      detailHtml += "</div></div></div></div>"
    }

    //지역구
    detailHtml += "<div class='card'>";
    detailHtml += "<div class='card-header'>";
    detailHtml += "<div class='popTitle'><i class='fas fa-layer-group'></i>&nbsp&nbsp" + $('#sido option:selected').text() + " " + $('#gungu option:selected').text() + "</div>"
    detailHtml += "</div>";
    detailHtml += "<div class='card-body'>";
    detailHtml += "<div id='popEducation'>"
    detailHtml += "<div class='graph' style='height: 120px'> <canvas id='regionChart'></canvas></div>"
    detailHtml += "<div class='comment2'>지역구 정보는 공공데이터포탈 정보를 기반으로 산정됩니다.</div>"
    detailHtml += "</div></div></div>"

    //Footer에 네이버 부동산 버튼
    footerHtml += "<div class='modal-footer'>"
    //footerHtml += "<div></div>"
    shareTitle = "[아파트랭크 "
    shareTitle += selectedMonth.substr(2, 2) + "년 " + Number(selectedMonth.substr(4, 2)).toString() + "월]\n"

    shareText = "\n『" + aptName
    if(Number(selectedMonth) > 202203){      
      if(apt_type == "재건축"){
        shareText += "(" + aptDuration + "년차, 재건축)』"
      }else if(apt_type == "분양권"){
        shareText += "(" + aptData.data[index]["준공년월"].substr(0, 7) + " 예정)』"        
      }
      else{
        shareText += "(" + aptDuration + "년차)』"
      }
    }
    else{
      if(aptDuration >= 30){
        shareText += "(" + aptDuration + "년차, 재건축 대상)』"
      }else{
        shareText += "(" + aptDuration + "년차)』"
      }
    }

    shareText += "\nㆍ지역 : " + $('#sido option:selected').text() + " " + $('#gungu option:selected').text()
    shareText += "\nㆍ순위 : " + aptRank + " (" + sortName + ")"

    if(isNaN(last_sales_price)){
      shareText += "\nㆍ최근실거래 : 거래 정보 없음"
    }
    else{
      shareText += "\nㆍ최근실거래\n    : " + last_sales_area + ", " + Math.round(last_sales_price/100)/100 + "억, "+ last_sales_date.substr(2)
    }
    if(house_num == null){
      house_num = 0
    }

    if(Number(selectedMonth) > 202203){
      if(apt_type >= "재건축"){
        shareText += "\nㆍ용적률 : " + floor_rate
        shareText += "\nㆍ건폐율 : " + cover_rate
      }else{
        shareText += "\nㆍ세대수 : " + house_num.toLocaleString() + "세대"
        shareText += "\nㆍ주차 : " + parking
      }
    }
    else{
      if(aptDuration >= 30){
        shareText += "\nㆍ용적률 : " + floor_rate
        shareText += "\nㆍ건폐율 : " + cover_rate
      }else{
        shareText += "\nㆍ세대수 : " + house_num.toLocaleString() + "세대"
        shareText += "\nㆍ주차 : " + parking
      }
    }
    
    //if(aptData.data[index]["가까운역이름"] != "NA" || aptData.data[index]["가까운역이름"] != null){      
    //  shareText += "\nㆍ가장 가까운 역 : " + nearestStation
    //}
    shareText += "\nㆍ5km 이내 대형병원 : " + bigHospital_5km
    shareText += "\nㆍ중학교 보통 학력 이상 : " + mSchool_edu
    shareText += "\n"
    shareURL = "https://www.aptrank.kr" + "?reg=" + selectedRegion +"&sub=" + selectedSubRegion + "&mon=" + selectedMonth + "&complex=" + index + "&sort=" + sortSelection

    if(broswerInfo.indexOf("inApp")>-1){
      if(apt_type == "분양(예정)"){
        footerHtml += "<div></div>"
        footerHtml += "<div><button type='button' class='goLink_HGNN' onclick='openHGNN(\"" + searchCode + "\")'>호갱노노 보기</button></div>"
        footerHtml += "<div><button type='button' class='kakaoShare' onClick='kakaoShare(shareTitle, shareText, shareURL)'><i class='fa-solid fa-comment'></i></button></div>"
      }
      else{
        footerHtml += "<div></div>"
        footerHtml += "<div><button type='button' class='goLink' onclick='openNaver(" + searchCode + ")'>네이버 부동산 보기</button></div>"
        footerHtml += "<div><button type='button' class='kakaoShare' onClick='kakaoShare(shareTitle, shareText, shareURL)'><i class='fa-solid fa-comment'></i></button></div>"
      }
    }
    else{
      if(apt_type == "분양(예정)"){
        footerHtml += "<div><button type='button' class='goLink_HGNN' onclick='openHGNN(\"" + searchCode + "\")'>호갱노노 보기</button></div>"
        footerHtml += "<div><button type='button' class='kakaoShare' onClick='kakaoShare(shareTitle, shareText, shareURL)'><i class='fa-solid fa-comment'></i></button></div>"
        footerHtml += "<div><button type='button' class='toShare' onClick='share(shareTitle, shareText, shareURL)' style='background:#ffffff; font-size:1.2em'><i class='fa-solid fa-arrow-up-right-from-square'></i></button></div>"
      }
      else{
        footerHtml += "<div><button type='button' class='goLink' onclick='openNaver(\"" + searchCode + "\")'>네이버 부동산 보기</button></div>"
        footerHtml += "<div><button type='button' class='kakaoShare' onClick='kakaoShare(shareTitle, shareText, shareURL)'><i class='fa-solid fa-comment'></i></button></div>"
        footerHtml += "<div><button type='button' class='toShare' onClick='share(shareTitle, shareText, shareURL)' style='background:#ffffff; font-size:1.2em'><i class='fa-solid fa-arrow-up-right-from-square'></i></button></div>"
      }
    }
    footerHtml += "</div>"

    $('#exampleModalLabel').html(titleHtml);
    $('#aptDetail').html(detailHtml);
    $('#footer').html(footerHtml);

    if(broswerInfo.indexOf("inApp")>-1){
      $('.modal-footer').css({"grid-template-columns" : "0.2fr 1fr 0.2fr", "text-align":"center", "text-align": "-webkit-center"})
    }
    else{
      $('.modal-footer').css({"grid-template-columns" : "1fr 0.15fr 0.15fr", "text-align":"center", "text-align": "-webkit-center"})
    }

    if(Number(selectedMonth) > 202203){
      rank_history = aptData.data[index]["rank_history"]
      rankMonth = [""]
      rankData = [null]
      for(var j = 0 ; j < rank_history.length ; j++){
        if(rank_history[j][1] == 9999){
        }
        else if(rank_history[j][1] == 0){
          rankMonth.push(rank_history[j][0])
          rankData.push(aptData.data[index]["rank"])
        }
        else{
          rankMonth.push(rank_history[j][0])
          rankData.push(rank_history[j][1])
        }
      }
      rankMonth.push("")
      rankData.push(null)

      rankMonth.reverse()
      rankData.reverse()
      drawRankChart(rankMonth, rankData, aptData.data[itemNum-1]["rank"])
    }

    drawChart(aptValue, livingScore, transportScore, infraScore, eduScore)
    drawSubChart(livingScore, avgLivingScore, "주거총점", "지역평균", "#fe4040", "#9f9f9f",  "livingChart")
    if(isNaN(transportScore) == false){
      drawSubChart(transportScore, avgTransportScore, "교통총점", "지역평균", "#fe4040", "#9f9f9f", "transportChart")
    }
    drawSubChart(infraScore, avgInfraScore, "인프라총점", "지역평균", "#fe4040", "#9f9f9f", "infraChart")
    drawSubChart(eduScore, avgEduScore, "교육총점", "지역평균", "#fe4040", "#9f9f9f", "eduChart")
    drawSubChart(eduScore, avgEduScore, "인구총점", "일자리총점", "#fe4040", "#fe4040", "regionChart")

    if(Number(selectedMonth) > 202209){
      price_sOption = ""
      price_eOption = ""
      for(w = 0 ; w < sales_history_date.length-1 ; w++){
          price_sOption += "<option value='" + w + "'>" + "'" + sales_history_date[w].substr(2, 2)+ "." + sales_history_date[w].substr(4, 2)  + "</option>"
      }
      for(w = 1 ; w < sales_history_date.length ; w++){
          price_eOption += "<option value='" + w + "'>" + "'" + sales_history_date[w].substr(2, 2)+ "." + sales_history_date[w].substr(4, 2)  + "</option>"
      }
      $('#pStart').html(price_sOption)
      $("#pStart").val(0).prop("selected", true);

      $('#pEnd').html(price_eOption)
      $("#pEnd").val(sales_history_date.length-1).prop("selected", true);

      priceChartDraw(priceCharts, sales_history_price, sales_history_date, 0, sales_history_date.length)
    }    
  }

  function graphShowHide(obj){
    if(obj.checked){
      $('.priceGraph').show()
      $('.popSubPriceTable').css({'margin-top' : '10px', 'margin-bottom' : '10px'})
    }
    else{
      $('.priceGraph').hide()
      $('.popSubPriceTable').css({'margin-top' : '3px', 'margin-bottom' : '0px'})
    }    
  }

  function price_sDateChange(obj){    
    startVal = Number(obj.value) + 1
    endVal = $("#pEnd").val()    

    eDateOption = ""
    for(var w = startVal ; w < sales_history_date.length ; w++){
      eDateOption += "<option value='" + w + "'>" + "'" + sales_history_date[w].substr(2, 2)+ "." + sales_history_date[w].substr(4, 2)  + "</option>"      
    }    
    $('#pEnd').html(eDateOption)

    if(endVal > startVal){
      $("#pEnd").val(endVal).prop("selected", true);
    }
    else{
      endVal = $("#pEnd").val() 
    }

    priceChartUpdate(priceCharts, sales_history_price, sales_history_date, startVal, endVal)
  }

  function price_eDateChange(obj){    
    startVal = $("#pStart").val()  
    endVal = Number(obj.value) - 1

    priceChartUpdate(priceCharts, sales_history_price, sales_history_date, startVal, endVal)
  }

  function priceChartUpdate(priceChart, sales_history_price, sales_history_date, sVal, eVal){
    for(var p=0 ; p < priceChart.length ; p++){
      sales_grayHistory1 = []
      sales_pHistory = []
      sales_grayHistory2 = []

      sales_pHistory.push(null)
      sales_grayHistory1.push(null)
      sales_grayHistory2.push(null)

      sales_dHistory = []      
      sales_dHistory.push("")

      for(var y = 0 ; y < sales_history_date.length ; y++){
        if(y < sVal){
          if(sales_history_price[p][y] == 0){
            sales_grayHistory1.push(0)
          }
          else{
            sales_grayHistory1.push((sales_history_price[p][y]/10000).toFixed(1))
          }
          sales_pHistory.push(null)
          sales_grayHistory2.push(null)
        }
        if( y >= sVal && y <= eVal){
          sales_grayHistory1.push(null)
          if(sales_history_price[p][y] == 0){
            sales_pHistory.push(0)
          }
          else{
            sales_pHistory.push((sales_history_price[p][y]/10000).toFixed(1))
          }
          sales_grayHistory2.push(null)
        }
        if(y > eVal){
          sales_grayHistory1.push(null)
          sales_pHistory.push(null)
          if(sales_history_price[p][y] == 0){
            sales_grayHistory2.push(0)
          }
          else{
            sales_grayHistory2.push((sales_history_price[p][y]/10000).toFixed(1))
          }
        }
        //sales_pHistory.push( (sales_history_price[p][y]/10000).toFixed(1) )        
        sales_dHistory.push( "'" + sales_history_date[y].substr(2, 2) + "." + sales_history_date[y].substr(4, 2))        
      }      
      sales_pHistory.push(null)
      sales_grayHistory1.push(null)
      sales_grayHistory2.push(null)
      sales_dHistory.push("")
      
      chartView[p].data.datasets[0].data = sales_grayHistory1
      chartView[p].data.datasets[1].data = sales_pHistory
      chartView[p].data.datasets[2].data = sales_grayHistory2
      chartView[p].update();

      sPrice = sales_history_price[p][sVal]
      ePrice = sales_history_price[p][eVal-1]
      priceGap = ( (ePrice - sPrice) / 10000 ).toFixed(2)
      priceRatio = ( (ePrice/sPrice -1 ) * 100 ).toFixed(1)

      priceChangeText = ""      
      priceChangeText += (sPrice/10000).toFixed(2) + " → " + (ePrice/10000).toFixed(2) + "억"

      priceRatioText = ""
      if(sPrice == 0){
        priceRatioText += " ( --- , --- )"
      }
      else{
        if(priceGap >= 0){
          priceRatioText += " (+" + priceGap + "억, "
        }
        else{
          priceRatioText += " (" + priceGap + "억, "
        }

        if(priceRatio > 0){
          priceRatioText += "<span style='color:#fe4040'>▲" + priceRatio + "%</span>)"
        }
        else if (priceRatio == 0){
          priceRatioText += "<span style='color:#000'>" + priceRatio + "%</span>)"
        }
        else{
          priceRatioText += "<span style='color:blue'>▼" + (priceRatio*-1) + "%</span>)"
        }
      }
      $('#pChange'+p).html(priceChangeText)    
      $('#pRatio'+p).html(priceRatioText)      
    }     
  }

  function priceChartDraw(priceChart, sales_history_price, sales_history_date, sVal, eVal){
    for(var p=0 ; p < priceChart.length ; p++){
      sales_grayHistory1 = []
      sales_pHistory = []
      sales_grayHistory2 = []

      sales_pHistory.push(null)
      sales_grayHistory1.push(null)
      sales_grayHistory2.push(null)

      sales_dHistory = []      
      sales_dHistory.push("")

      for(var y = 0 ; y < sales_history_date.length ; y++){
        if(y < sVal){
          if(sales_history_price[p][y] == 0){
            sales_grayHistory1.push(0)
          }
          else{
            sales_grayHistory1.push((sales_history_price[p][y]/10000).toFixed(1))
          }
          sales_pHistory.push(null)
          sales_grayHistory2.push(null)
        }
        if( y >= sVal && y <= eVal){
          sales_grayHistory1.push(null)
          if(sales_history_price[p][y] == 0){
            sales_pHistory.push(0)
          }
          else{
            sales_pHistory.push((sales_history_price[p][y]/10000).toFixed(1))
          }
          sales_grayHistory2.push(null)
        }
        if(y > eVal){
          sales_grayHistory1.push(null)
          sales_pHistory.push(null)
          if(sales_history_price[p][y] == 0){
            sales_grayHistory2.push(0)
          }
          else{
            sales_grayHistory2.push((sales_history_price[p][y]/10000).toFixed(1))
          }
        }
        //sales_pHistory.push( (sales_history_price[p][y]/10000).toFixed(1) )
        sales_dHistory.push( "'" + sales_history_date[y].substr(2, 2) + "." + sales_history_date[y].substr(4, 2))        
      }      
      sales_pHistory.push(null)
      sales_grayHistory1.push(null)
      sales_grayHistory2.push(null)
      sales_dHistory.push("")

      priceMax = Math.max(...sales_pHistory) * 1.3
      drawPriceChart(sales_dHistory, sales_grayHistory1, sales_pHistory, sales_grayHistory2, priceChart[p], priceMax, p)
      
      sPrice = sales_history_price[p][sVal]
      ePrice = sales_history_price[p][eVal-1]
      priceGap = ( (ePrice - sPrice) / 10000 ).toFixed(2)
      priceRatio = ( (ePrice/sPrice -1 ) * 100 ).toFixed(1)

      sPrice = sales_history_price[p][sVal]
      ePrice = sales_history_price[p][eVal-1]
      priceGap = ( (ePrice - sPrice) / 10000 ).toFixed(2)
      priceRatio = ( (ePrice/sPrice -1 ) * 100 ).toFixed(1)

      priceChangeText = ""      
      priceChangeText += (sPrice/10000).toFixed(2) + " → " + (ePrice/10000).toFixed(2) + "억"

      priceRatioText = ""
      if(sPrice == 0){
        priceRatioText += " ( --- , --- )"
      }
      else{
        if(priceGap >= 0){
          priceRatioText += " (+" + priceGap + "억, "
        }
        else{
          priceRatioText += " (" + priceGap + "억, "
        }

        if(priceRatio > 0){
          priceRatioText += "<span style='color:#fe4040'>▲" + priceRatio + "%</span>)"
        }
        else if (priceRatio == 0){
          priceRatioText += "<span style='color:#000'>" + priceRatio + "%</span>)"
        }
        else{
          priceRatioText += "<span style='color:blue'>▼" + (priceRatio*-1) + "%</span>)"
        }
      }
      $('#pChange'+p).html(priceChangeText)    
      $('#pRatio'+p).html(priceRatioText) 
    }
  }

  function updateRegionTable(month, region){
    $('html').scrollTop(0)
    $('#sort').css("visibility", "hidden")
    $('#rearrange').css("visibility", "visible")
    url = "https://www.aptrank.kr/" + month + "/" + region + ".json"
    $('#dataList').html("");

    setTimeout(function(){}, 250)

    $.getJSON(url, function(json) {        
        regData = json;
        regSortData = regData;
        itemNum = json.data.length;
        regValueSum = 0;
        regSupplySum = 0;
        regPopSum = 0;
        regJobSum = 0;

        for(var i = 0 ; i < itemNum ; i++){
          var regName = regData.data[i]["시도"]

          var regSuplyLevel = regData.data[i]["공급수준"]
          var regPopChange = regData.data[i]["인구증감"]
          var regPop = regData.data[i]["인구수"]
          var regIncome = regData.data[i]["소득수준"]
          var regValue = Math.round( regData.data[i]["가치 총점"] * 100 ) / 100;
          var regRank = regData.data[i]["rank"]
          var regJob = regData.data[i]["일자리"]

          regValueSum += regData.data[i]["가치 총점"]
          regSupplySum += regData.data[i]["지역구공급총점"]
          regPopSum += regData.data[i]["인구총점"]
          regJobSum += regData.data[i]["일자리총점"]

          var addon_html = "<div class='listBox' data-bs-toggle='modal' data-bs-target='#exampleModal' id='myModal' onClick='showRegionDetail(" + i + ")'>";

          if(selectedMonth == "202201"){
            addon_html += "<div class='rank_content'>"
            addon_html += "<div class='rank'>" + regRank + "위</div>";
            addon_html += "</div>"
          }
          else{
            addon_html += "<div class='rank_content'>"
            addon_html += "<div class='rank'>" + regRank + "위</div>";
            if(regData.data[i]["rank_gap"] == 0){
              addon_html += "<div class='ranksame'> -- </div>"
            }
            else if(regData.data[i]["rank_gap"] == 9999){
              addon_html += "<div class='ranksame'> NEW! </div>"
            }
            else if(regData.data[i]["rank_gap"] > 0){
              addon_html += "<div class='rankup'> ▲" + Math.abs(regData.data[i]["rank_gap"]) + "</div>"
            }
            else if(regData.data[i]["rank_gap"] < 0){
              addon_html += "<div class='rankdown'> ▼" + Math.abs(regData.data[i]["rank_gap"]) + "</div>"
            }

            addon_html += "</div>"
          }

          addon_html += "<div class='content'>";
          addon_html += "<div class='apt_name'>" + regName + "</div>";
          addon_html += "<div class='reg_subTable'>";

          addon_html += "<div class='apt_address'>아파트 공급량 <span style='font-weight:900; color:#0f0f0f'>" + regSuplyLevel + "</span></div>";

          var upDown = ""
          var popChange = ""
          if (regPopChange < 0){
            upDown = "감소"
            popChange = "▼" + (Math.abs(regPopChange)).toLocaleString()
          }
          else{
            upDown = "증가"
            popChange = "▲" + (Math.abs(regPopChange)).toLocaleString()
          }
          addon_html += "<div class='apt_address'><span class='regionPop'>인구 " + (Math.abs(regPop)).toLocaleString() + "명</span>"
          if(regPopChange >= 0){
            addon_html += "<span class='regionPopUp'>(" + popChange + ")</span></div>";
          }
          else{
            addon_html += "<span class='regionPopDown'>(" + popChange + ")</span></div>";
          }
          addon_html += "<div class='apt_address'><span class='regionJob'>일자리 " + regJob.toLocaleString() + "개</span></div>";
          addon_html += "<div class='apt_address'>소득 " + regIncome.toLocaleString() + "원</div>";
          addon_html += "</div></div>";
          addon_html += "<div class='value_score'>" + ( Math.round( regValue * 100 ) / 100 ).toFixed(2) + "점</div>"
          addon_html += "</div>"

          $('#dataList').append(addon_html);
        }
        $('#dataList').append("<div style='height: 2em'></div>");
    })

    saveLocalStorage()
  }

  function showRegionDetail(index){
    titleHtml = "";
    detailHtml = "";
    footerHtml = "";
    var regRank = regData.data[index]["rank"] + "/" + regData.data[itemNum-1]["rank"] + "위"
    var regName = regData.data[index]["시도"]
    var regValue = ( Math.round(regData.data[index]["가치 총점"] * 100) / 100).toFixed(2)

    var regSupplyAll = regData.data[index]["총물량"]
    var regSupplyProper = regData.data[index]["적정입주물량"]
    var regSupplyUpDown = Math.abs(regData.data[index]["과부족수"])

    if(Number(selectedMonth) > 202208){ 
      var regSupplyAll_nearby = regData.data[index]["인근총합공급량"]
      var regSupplyProper_nearby = regData.data[index]["총합적정공급량"]
      var regSupplyUpDown_nearby = Math.abs(regData.data[index]["총합과부족수"])
      var nearby_info = regData.data[index]["인근지역정보"]
    }

    var regSupplyLevel = regData.data[index]["공급수준"]
    var regSupplyScore = ( Math.round(regData.data[index]["지역구공급총점"] * 100) / 100).toFixed(2)

    var regPop = regData.data[index]["인구수"]
    var regPopUpDown = regData.data[index]["인구증감"]
    var regPopScore = ( Math.round(regData.data[index]["인구총점"] * 100) / 100).toFixed(2)

    var regJob = regData.data[index]["일자리"]
    var regIncome = regData.data[index]["소득수준"]
    var regJobScore = ( Math.round(regData.data[index]["일자리총점"] * 100) / 100).toFixed(2)
    linked = regData.data[index]["연결명"]

    //Title
    //titleHtml += "<div class='popupTitle'>" + aptName + " " + apt_p + "(" + apt_m + ")</div>";
    titleHtml += "<div class='popupTitle'>" + regName + "</div>";

    //총점,순위
    detailHtml += "<div class='card'>";
    detailHtml += "<div class='card-header'>";

      if(selectedMonth == "202201"){
        detailHtml += "<div class='popRank'><i class='fas fa-trophy'></i> " + regRank + "</div></div>";
      }
      else{
        detailHtml += "<div class='popRank'><i class='fas fa-trophy'></i> " + regRank;
        if(regData.data[index]["rank_gap"] == 0){
          detailHtml += "<span class='ranksame'> (--) </span>"
        }
        else if(regData.data[index]["rank_gap"] == 9999){
          detailHtml += "<span class='ranksame'> (NEW!) </span>"
        }
        else if(regData.data[index]["rank_gap"] > 0){
          detailHtml += "<span class='rankup'> (▲" + Math.abs(regData.data[index]["rank_gap"]) + ")</span>"
        }
        else if(regData.data[index]["rank_gap"] < 0){
          detailHtml += "<span class='rankdown'>(▼" + Math.abs(regData.data[index]["rank_gap"]) + ")</span>"
        }
        detailHtml += "</div></div>"
      }

    detailHtml += "<div class='card-body'>";
    detailHtml += "<div class='graph' style='height: 200px'> <canvas id='valueChart'></canvas></div>"
    detailHtml += "<div class='comment'>(전국 모든 시군구에 대해 100점으로 환산한 상대 점수 입니다.)</div>"

    if(Number(selectedMonth) > 202203){
      detailHtml += "<hr><div class='graph' style='height: 120px;'> <canvas id='rankChart'></canvas></div>"
    }

    detailHtml += "</div></div>"

    //물량
    detailHtml += "<div class='card'>";
    detailHtml += "<div class='card-header'>";
    var start_y = selectedMonth.substr(0, 4)
    var end_y = (Number(start_y) + 1).toString()
    var start_m = selectedMonth.substr(4, 2)
    var duration = "<span style='font-size:0.8em'> (" + start_y + "-" + start_m + " ~ " + end_y + "-" + start_m + ") </span>"
    if(Number(selectedMonth) > 202208){
      detailHtml += "<div class='popTitle'><i class='fas fa-building'></i>&nbsp&nbsp공급량" + duration + "</div>"
      detailHtml += "<div class='comment2'>2022년 9월 부터 인근 지역의 공급량 총합으로 과부족을 표시합니다.</div>"
      detailHtml += "<div class='comment2'>적정 공급량은 \"인구 X 0.5%\"로 계산됩니다.</div>"
    }
    else{
      detailHtml += "<div class='popTitle'><i class='fas fa-building'></i>&nbsp&nbsp공급량</div>"      
    }
    detailHtml += "</div>";
    detailHtml += "<div class='card-body'>";
    detailHtml += "<div id='popLiving'>"
    detailHtml += "<div class='popTable'>"
    //detailHtml += "<div class='graph' style='height: 120px'> <canvas id='supplyChart'></canvas></div>"
    if(Number(selectedMonth) < 202209){      
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "총 공급량" + "</div>" + "<div class='popResult'>" + ( Math.round(regSupplyAll) ).toLocaleString() + "세대</div></div>";
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "적정 공급량" + "</div>" + "<div class='popResult'>" + ( Math.round(regSupplyProper) ).toLocaleString() + "세대</div></div>";
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "과부족" + "</div>" + "<div class='popResult'>" + ( Math.round(regSupplyUpDown) ).toLocaleString() + "세대 " + regSupplyLevel + "</div></div>";
      detailHtml += "</div></div></div></div>"
    }
    else{      
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "총 공급량" + "</div>" + "<div class='popResult'>" + ( Math.round(regSupplyProper_nearby) ).toLocaleString() + "세대</div></div>";
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "적정 공급량" + "</div>" + "<div class='popResult'>" + ( Math.round(regSupplyAll_nearby) ).toLocaleString() + "세대</div></div>";      
      detailHtml += "<div class='popSubTable'><div class='popContent'>" + "과부족" + "</div>" + "<div class='popResult'>" + ( Math.round(regSupplyUpDown_nearby) ).toLocaleString() + "세대 " + regSupplyLevel + "</div></div>";

      detailHtml += "<div class='column2'>"
        detailHtml += "<div class='column_table'>"
          detailHtml += "<div class='column_table_title'>" + regName + "</div>"
          detailHtml += "<div class='column_table_content'>"
          if (regData.data[index]["과부족수"] > 0){
              vol_info = "부족"
          }
          else if (regData.data[index]["과부족수"] < 0){
            vol_info = "과다"
          }
          else if (regData.data[index]["과부족수"] == 0){
            vol_info = "적정"
          }
          detailHtml += "<div class='supplySubTable'><div class='supplyResult'>" + regSupplyUpDown.toFixed() + "세대 공급 " + vol_info + "</div></div>";
          detailHtml += "</div>"
          detailHtml += "</div>"

        for(var i = 0 ; i < nearby_info.length ; i++){
          detailHtml += "<div class='column_table'>"
            region_name_array = nearby_info[i][0].split(" ")
            short_region_name = ""
            for(var k = 1; k < region_name_array.length; k++){
              short_region_name += region_name_array[k]
              short_region_name += " "
            }

            detailHtml += "<div class='column_table_title'>" + short_region_name + "<span style='font-size:0.9em'>(" + nearby_info[i][5].toFixed(1) + " km)</span>"
            detailHtml += "</div>"
            detailHtml += "<div class='column_table_content'>"
              if (nearby_info[i][2]-nearby_info[i][3] > 0){
                vol_info = "과다"
              }
              else if (nearby_info[i][2]-nearby_info[i][3] < 0){
                vol_info = "부족"
              }
              else if (nearby_info[i][2]-nearby_info[i][3] == 0){
                vol_info = "적정"
              }
              //detailHtml += "<div class='supplySubTable'><div class='supplyContent'>" + "" + "</div>" + "<div class='supplyResult'>" + (nearby_info[i][3].toFixed()).toLocaleString() + "세대 적정 공급</div></div>";
              detailHtml += "<div class='supplySubTable'><div class='supplyResult'>" + (Math.abs(nearby_info[i][2]-nearby_info[i][3]).toFixed()).toLocaleString() + "세대 공급 " + vol_info + "</div></div>";
            detailHtml += "</div>"
          detailHtml += "</div>"
        }
        detailHtml += "</div></div></div></div></div>"
    }    
    avgSupplyScore = ( Math.round( regSupplySum/itemNum * 100 ) / 100 ).toFixed(2)

    //인구
    detailHtml += "<div class='card'>";
    detailHtml += "<div class='card-header'>";
    detailHtml += "<div class='popTitle'><i class='fas fa-user-friends'></i>&nbsp&nbsp인구</div>"
    detailHtml += "</div>";
    detailHtml += "<div class='card-body'>";
    detailHtml += "<div id='popInfra'>"
    detailHtml += "<div class='graph' style='height: 120px'> <canvas id='popChart'></canvas></div>"
    detailHtml += "<div class='popTable'>"
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "인구수" + "</div>" + "<div class='popResult'>" + regPop.toLocaleString() + "명 </div></div>";
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "인구증가" + "</div>" + "<div class='popResult'>" + ( Math.round(regPopUpDown) ).toLocaleString() + "명</div></div>";
    detailHtml += "</div></div></div></div>"
    avgPopScore = ( Math.round( regPopSum/itemNum * 100 ) / 100 ).toFixed(2)

    //일자리
    detailHtml += "<div class='card'>";
    detailHtml += "<div class='card-header'>";
    detailHtml += "<div class='popTitle'><i class='fas fa-user-md'></i></i>&nbsp&nbsp일자리</div>"
    detailHtml += "</div>";
    detailHtml += "<div class='card-body'>";
    detailHtml += "<div id='popEducation'>"
    detailHtml += "<div class='graph' style='height: 120px'> <canvas id='jobChart'></canvas></div>"
    detailHtml += "<div class='popTable'>"
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "일자리수" + "</div>" + "<div class='popResult'>" + regJob.toLocaleString() + "개</div></div>";
    detailHtml += "<div class='popSubTable'><div class='popContent'>" + "평균소득" + "</div>" + "<div class='popResult'>" + regIncome.toLocaleString() + "원</div></div>";
    detailHtml += "</div></div></div></div>"
    avgJobScore = ( Math.round( regJobSum/itemNum * 100 ) / 100 ).toFixed(2)


    //매매, 전세가격지수
    if(rateExist.includes(regName) && Number(selectedMonth) > 202203){
      url = "https://www.aptrank.kr/" + selectedMonth + "/Price_Rate/" + regName + ".json"

      detailHtml += "<div class='card'>";
      detailHtml += "<div class='card-header'>";
      detailHtml += "<div class='popTitle'><i class='fa-solid fa-chart-line'></i>&nbsp&nbsp매매/전세 가격 지수</div>"
      detailHtml += "</div>";
      detailHtml += "<div class='card-body'>";
      detailHtml += "<div id='popEducation'>"
      detailHtml += "<div class='graph' style='height: 200px;'> <canvas id='priceRateChart'></canvas></div>"
      detailHtml += "<hr><div class='comment2'>매매/전세 가격 지수는 KB부동산 정보를 참조하며, 2022년 1월의 가격을 100.0으로 설정한 기준으로 산정됩니다. 100초과는 매수우위, 100미만은 매도우위를 의미합니다.</div>"
      detailHtml += "</div></div></div>"
    }

    //Footer에 아파트보기 버튼
    var shortName = regName.substring(regName.search(' '), regName.length)
    var rName = regName.substring(0, regName.search(' '))
    for(var i = 0 ; i < regions.length; i++){
      if(regions[i][0] == rName){
        regionValue = regions[i][1]
      }
      else{}
    }

    shareTitle = "[아파트랭크 "
    shareTitle += selectedMonth.substr(2, 2) + "년 " + Number(selectedMonth.substr(4, 2)).toString() + "월]\n\n"

    shareText = "『" + regName + "』"
    shareText += "\nㆍ순위 : " + regRank + " (" + regValue + "점)"
    shareText += "\nㆍ인구수 : " + regPop.toLocaleString() + "명"
    shareText += "\nㆍ공급량 : " + ( Math.round(regSupplyUpDown) ).toLocaleString() + "세대 " + regSupplyLevel
    shareText += "\nㆍ일자리 : " + regJob.toLocaleString() + "개"
    shareText += "\n\n"
    shareURL = "https://www.aptrank.kr" + "?reg=" + selectedRegion +"&sub=" + selectedSubRegion + "&mon=" + selectedMonth

    footerHtml += "<div class='modal-footer'>"
    //footerHtml += "<div></div>"

    if(broswerInfo.indexOf("inApp")>-1){
      footerHtml += "<div></div>"
      footerHtml += "<div><button type='button' class='goApt' data-dismiss='modal' onClick='show_apt(selectedMonth, linked, regionValue)'>" + shortName + " 아파트 보기</button></div>"
      footerHtml += "<div><button type='button' class='kakaoShare' onClick='kakaoShare(shareTitle, shareText, shareURL)'><i class='fa-solid fa-comment'></i></button></div>"
    }
    else{
      footerHtml += "<div><button type='button' class='goApt' data-dismiss='modal' onClick='show_apt(selectedMonth, linked, regionValue)'>" + shortName + " 아파트 보기</button></div>"
      footerHtml += "<div><button type='button' class='kakaoShare' onClick='kakaoShare(shareTitle, shareText, shareURL)'><i class='fa-solid fa-comment'></i></button></div>"
      footerHtml += "<div><button type='button' class='toShare' onClick='share(shareTitle, shareText, shareURL)' style='background:#ffffff; font-size:1.2em'><i class='fa-solid fa-arrow-up-right-from-square'></i></button></div>"
    }
    footerHtml += "</div>"

    $('#exampleModalLabel').html(titleHtml);
    $('#aptDetail').html(detailHtml);
    $('#footer').html(footerHtml);

    if(broswerInfo.indexOf("inApp")>-1){
      $('.modal-footer').css({"grid-template-columns" : "0.2fr 1fr 0.2fr", "text-align":"center"})
    }
    else{
      $('.modal-footer').css({"grid-template-columns" : "1fr 0.15fr 0.15fr", "text-align":"center"})
    }

    if(Number(selectedMonth) > 202203){
      rank_history = regData.data[index]["rank_history"]
      rankMonth = [""]
      rankData = [null]
      for(var j = 0 ; j < rank_history.length ; j++){
        if(rank_history[j][1] == 9999){
        }
        else if(rank_history[j][1] == 0){
          rankMonth.push(rank_history[j][0])
          rankData.push(regData.data[index]["rank"])
        }
        else{
          rankMonth.push(rank_history[j][0])
          rankData.push(rank_history[j][1])
        }
      }
      rankMonth.push("")
      rankData.push(null)

      rankMonth.reverse()
      rankData.reverse()

      drawRankChart(rankMonth, rankData, regData.data[itemNum-1]["rank"])
    }
    drawChart(regValue, regSupplyScore, regPopScore, regJobScore, "region")
    //drawSubChart(regSupplyScore, avgSupplyScore, "공급량총점", "전국평균", "#fe4040", "#9f9f9f", "supplyChart")
    drawSubChart(regPopScore, avgPopScore, "인구총점", "전국평균", "#fe4040", "#9f9f9f", "popChart")
    drawSubChart(regJobScore, avgJobScore, "일자리총점", "전국평균", "#fe4040", "#9f9f9f", "jobChart")
    //drawPriceRateChart(dateArray, salesArray, rentArray)

    if(Number(selectedMonth) > 202203){
      var dateArray = ["", ""]
      var salesArray = [null, null]
      var rentArray = [null, null]

      $.getJSON(url, function(json) {
        rateData = json
        for (var i = 0 ; i < (rateData.data).length ; i++){
          dateArray.push(rateData.data[i]["Date"])
          salesArray.push(rateData.data[i]["Sales"])
          rentArray.push(rateData.data[i]["Rent"])
        }

        dateArray.push("")
        dateArray.push("")
        salesArray.push(null)
        salesArray.push(null)
        rentArray.push(null)
        rentArray.push(null)

        drawPriceRateChart(dateArray, salesArray, rentArray)
      })
    }
  }

  function show_apt(month, filename, sido){
    $("#sido").val(sido).prop("selected", true);
    selectedMonth = month
    selectedSubRegion = filename
    selectedRegion = $("#sido option:selected").val();

    $("#regionSearchCard").animate({
        opacity: 0.0,
        top: '-150px'
      }, 400, 'easeInQuad'
    );
    $("#closeRegionSearch_floating").animate({
        opacity: 0.0,
        right: '-200px'
      }, 400, 'easeInQuad'
    );
    $('#regionInputSearch').val("")

    $("#rearrangeRegionCard").animate({
        opacity: 0.0,
        top: '-150px'
      }, 400, 'easeInQuad'
    );
    $("#closeRegionRearrange_floating").animate({
        opacity: 0.0,
        right: '-200px'
      }, 400, 'easeInQuad'
    );
    rearrangeSelection = "rearrangeRegionScore"

    $('#exampleModal').modal('hide');
    $('#toggleModal1').modal("hide");
    $('#toggleModal2').modal("hide");

    optionChange(filename)    
    updateRegion()
  }

  var pcDevice = "win16|win32|win64|mac|macintel"

  function openNaver(code){
    nURL = "https://new.land.naver.com/complexes/" + code
    window.open(nURL)
  }

  function openHGNN(code){
    hURL = "https://hogangnono.com/apt/" + code
    window.open(hURL)
  }

  function openAptrank(){
    aURL = "https://www.aptrank.kr/theme" + "?reg=" + selectedRegion +"&sub=" + selectedSubRegion
    if ( navigator.platform ) {
        if ( pcDevice.indexOf(navigator.platform.toLowerCase()) < 0 ) {
          location.href = aURL
        } else {
          window.open(aURL)
        }
    }    
  }

  function openOprank(){
    aURL = "https://www.aptrank.kr/op" + "?reg=" + selectedRegion +"&sub=" + selectedSubRegion
    if ( navigator.platform ) {
        if ( pcDevice.indexOf(navigator.platform.toLowerCase()) < 0 ) {
          location.href = aURL
        } else {
          window.open(aURL)
        }
    }
  }
  function openAptrankBIZ(){
    aURL = "https://www.aptrank.kr/biz" + "?reg=" + selectedRegion +"&sub=" + selectedSubRegion
    if ( navigator.platform ) {
        if ( pcDevice.indexOf(navigator.platform.toLowerCase()) < 0 ) {
          location.href = aURL
        } else {
          window.open(aURL)
        }
    }
  }  

  function showNotice(){
    noticePop = true
    var titleHtml = "<div class='popupTitle'> 아파트랭크에서 알려드립니다 </div>";
    var footerHtml = ""
    var detailHtml = "<div class='notice'>아파트랭크는 '주거', '인프라', '교통', '교육환경'을 AI로 분석하여 점수로 계산하여 입지 정보를 제공하는 서비스 입니다.</div>"
    detailHtml +=  "<div class='notice'>아파트랭크의 점수는 '가격' 및 '지형고도'를 제외하고 산정되며, 그 결과는 생각하시는 순위와 크게 다를 수 있습니다.</div>";    
    detailHtml += "<div class='notice'><strong> 아파트랭크의 점수는 투자지표가 아님을 말씀드리며, 투자 판단에 대한 모든 책임은 투자자 본인에게 있습니다.</strong></div>";
    detailHtml += "<div class='notice'>업데이트 알림은 <a href='http://pf.kakao.com/_vESNb' target='_blank'>카카오톡 채널</a>을 통해 전달됩니다.</div>";
    detailHtml += "<hr>";

    if(selectedMonth == "202203"){ detailHtml += notice_202203 }
    if(selectedMonth == "202204"){ detailHtml += notice_202204 }
    if(selectedMonth == "202205"){ detailHtml += notice_202205 }
    if(selectedMonth == "202206"){ detailHtml += notice_202206 }
    if(selectedMonth == "202207"){ detailHtml += notice_202207 }
    if(selectedMonth == "202208"){ detailHtml += notice_202208 }
    if(selectedMonth == "202209"){ detailHtml += notice_202209 }
    if(selectedMonth == "202210"){ detailHtml += notice_202210 }
    if(selectedMonth == "202211"){ detailHtml += notice_202211 }

    detailHtml += "<div class='popupTitle' style='text-align: center; padding-bottom: 1em'>꼭 읽어주세요!</div>";
    detailHtml += "<ul>";
    detailHtml += "<li><div class='notice'>아파트 랭크의 점수는 투자지표가 아님을 말씀드립니다. 투자 판단에 대한 모든 책임은 투자자 본인에게 있습니다.</div></li>";
    detailHtml += "<li><div class='notice'>아파트 랭크는 개인이 개발했으며, 기관이나 기업과 전혀 관련이 없습니다.</li></div>";
    detailHtml += "<li><div class='notice'>모든 점수는 환경 요소를 분석한 AI가 선정하며, 일체의 임의적 조작을 가하지 않습니다.</div></li>";
    detailHtml += "<li><div class='notice'>점수는 해당 지역구의 상대 점수이며, 다른 지역구의 동일 점수와 같은 가치를 나타내지 않습니다.</div></li>";
    detailHtml += "<li><div class='notice'>단지의 정보는 네이버 부동산 정보를 참조합니다.</div></li>";
    detailHtml += "<li><div class='notice'>80세대 이하의 단지는 통계에서 제외됩니다. (2022년 3월 이전은 100세대 이하 제외)</div></li>";
    detailHtml += "<li><div class='notice'>재건축 단지의 경우, 용적률과 건폐율로 주거 점수를 산정합니다.</div></li>";
    detailHtml += "<li><div class='notice'>수도권 교통 정보는 지하철역 위치 정보를 기반으로 산정됩니다.</div></li>";
    detailHtml += "<li><div class='notice'>인프라 정보는 각 백화점/마트 홈페이지, 은행연합회, 자원순환정보시스템, 공공데이터 포탈의 정보를 기반으로 산정됩니다.</div></li>";
    detailHtml += "<li><div class='notice'>교육 정보는 교육통계서비스 정보를 기반으로 산정됩니다.</div></li>";
    detailHtml += "<li><div class='notice'>지역구 정보는 공공데이터포탈 정보를 기반으로 산정됩니다.</div></li>";
    detailHtml += "<li><div class='notice'>모든 정보는 월 1회 업데이트 예정이며, 각 기반 정보의 업데이트 시점에 따라 변동 가능성이 있습니다.</div></li>";
    detailHtml += "<li><div class='notice'>문의사항, 오류수정, 개선제안은 이메일 또는 카카오톡을 통해 문의해 주세요.</div></li>";
    detailHtml += "</ul>";

    footerHtml += "<div class='modal-footer'>"    
    footerHtml += " <div id='footerCheck'><input class='form-check-input' type='checkbox' value='' id='flexCheckDefault'><label class='form-check-label' for='flexCheckDefault'><span class='notice'>일주일 동안 보지 않기</span></label></div>"
    footerHtml += " <div id='footerBtn1'><a href='https://play.google.com/store/apps/details?id=com.aptrank.app' target='_blank'><button type='button' class='goApt' style='font-size: 0.85em'>앱 설치하기(안드로이드)</button></a></div>"
    //footerHtml += " <div><a href='https://open.kakao.com/o/sPYY0LZd' target='_blank'><button type='button' class='gokakao'>카카오톡 문의하기</button></a></div>"
    footerHtml += " <div id='footerBtn2'><a href='https://pf.kakao.com/_vESNb/chat' target='_blank'><button type='button' class='gokakao' style='font-size: 0.85em'>카카오톡 1:1 문의하기</button></a></div>"
    footerHtml += " <div id='footerBtn3'><a href='https://pf.kakao.com/_vESNb' target='_blank'><button type='button' class='gokakao' style='font-size: 0.85em'>카카오톡 채널로 업데이트 소식받기</button></a></div>"
    footerHtml += "</div>"  


    $('#exampleModalLabel').html(titleHtml);
    $('#aptDetail').html(detailHtml);
    $('#footer').html(footerHtml);

    $('#footerCheck').css({"grid-column" : "span 2", "height" : "2em"})
    $('#footerBtn3').css({"grid-column" : "span 2"})
    $('.modal-footer').css({"padding-top" : "3px"})

    if($.cookie('popCookie') != '202211'){
      $('#flexCheckDefault').prop("checked", false)
    }
    else{
      $('#flexCheckDefault').prop("checked", true)
    }

    $('#flexCheckDefault').change(function(){
      if($(this).is(':checked')){
        //console.log("CHECKED!!")
        $.cookie('popCookie', '202211', { expires: 7, path: '/' });
        console.log($.cookie('popCookie'))
      }
      else{
        //console.log("UN-CHECKED!!")
        $.removeCookie('popCookie', null, { path: '/' });
      }
    })
  }
</script>
</html>
